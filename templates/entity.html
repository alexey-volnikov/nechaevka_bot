<!doctype html> <!-- –û–±—ä—è–≤–ª—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
<html lang="ru"> <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<head> <!-- –ù–∞—á–∞–ª–æ —à–∞–ø–∫–∏ -->
  <meta charset="UTF-8" /> <!-- –ö–æ–¥–∏—Ä–æ–≤–∫–∞ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å -->
  <title>–ü—Ä–æ—Ñ–∏–ª—å {{ '—á–∞—Ç–∞' if entity_type == 'chat' else '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }}</title> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª–∞–¥–∫–∏ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" /> <!-- Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com" /> <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- –ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" /> <!-- –®—Ä–∏—Ñ—Ç Inter -->
  <style> /* –ù–∞—á–∞–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ç–∏–ª–µ–π */
    body { background: #0f172a; color: #e2e8f0; font-family: "Inter", system-ui, -apple-system, sans-serif; } /* –§–æ–Ω –∏ —Ç–µ–∫—Å—Ç */
    .glass { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; backdrop-filter: blur(10px); } /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Å—Ç–∏–ª—å */
    .shadow-soft { box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25); } /* –ú—è–≥–∫–∞—è —Ç–µ–Ω—å */
    .badge-soft { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; border: 1px solid rgba(99, 102, 241, 0.35); } /* –ú—è–≥–∫–∏–π –±–µ–π–¥–∂ */
    .avatar-lg { width: 64px; height: 64px; border-radius: 16px; object-fit: cover; } /* –ö—Ä—É–ø–Ω—ã–π –∞–≤–∞—Ç–∞—Ä */
    .avatar-inline { width: 1.6em; height: 1.6em; border-radius: 999px; object-fit: cover; flex-shrink: 0; } /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∞–≤–∞—Ç–∞—Ä */
    .stat-card { min-height: 140px; } /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .attachment-pill { display: inline-flex; gap: 6px; align-items: center; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(255, 255, 255, 0.05); color: #e2e8f0; font-size: 12px; text-decoration: none; } /* –ü–∏–ª—é–ª—è –≤–ª–æ–∂–µ–Ω–∏—è */
    .attachment-pill:hover { text-decoration: none; background: rgba(255, 255, 255, 0.08); } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏—è */
    .attachment-photo { border-color: rgba(59, 130, 246, 0.5); color: #bfdbfe; } /* –¶–≤–µ—Ç —Ñ–æ—Ç–æ */
    .attachment-video { border-color: rgba(244, 114, 182, 0.5); color: #fbcfe8; } /* –¶–≤–µ—Ç –≤–∏–¥–µ–æ */
    .attachment-doc { border-color: rgba(74, 222, 128, 0.5); color: #bbf7d0; } /* –¶–≤–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .attachment-link { border-color: rgba(14, 165, 233, 0.5); color: #bae6fd; } /* –¶–≤–µ—Ç —Å—Å—ã–ª–∫–∏ */
    .attachment-audio { border-color: rgba(56, 189, 248, 0.5); color: #bae6fd; } /* –¶–≤–µ—Ç –∞—É–¥–∏–æ */
    .attachment-sticker { border-color: rgba(248, 180, 0, 0.6); color: #fef08a; } /* –¶–≤–µ—Ç —Å—Ç–∏–∫–µ—Ä–∞ */
    .attachment-generic { border-color: rgba(148, 163, 184, 0.5); color: #e2e8f0; } /* –¶–≤–µ—Ç –ø—Ä–æ—á–µ–≥–æ */
    .table > :not(caption) > * > * { background-color: transparent; color: #e2e8f0; } /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —è—á–µ–π–∫–∏ */
    .table-striped > tbody > tr:nth-of-type(odd) > * { background: rgba(255, 255, 255, 0.03); } /* –ü–æ–ª–æ—Å–∞—Ç–æ—Å—Ç—å */
    .text-secondary-small { color: #94a3b8; font-size: 13px; } /* –°–µ—Ä—ã–π –º–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç */
    .gallery-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 16px; } /* –ó–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–π —Ñ–æ–Ω –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-body { background: #0b1220; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; max-width: 900px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35); display: flex; flex-direction: column; gap: 12px; padding: 16px; } /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-media { position: relative; min-height: 320px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.03); border-radius: 12px; overflow: hidden; } /* –ë–ª–æ–∫ –º–µ–¥–∏–∞ */
    .gallery-media img, .gallery-media video { max-height: 540px; width: 100%; object-fit: contain; border-radius: 12px; background: #0b1220; } /* –ú–µ–¥–∏–∞ –≤–Ω—É—Ç—Ä–∏ –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-actions { display: flex; align-items: center; justify-content: space-between; gap: 12px; } /* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-meta { display: flex; flex-direction: column; gap: 4px; font-size: 14px; color: #cbd5e1; } /* –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–ª–æ–∂–µ–Ω–∏—è */
    .gallery-nav-btn { min-width: 42px; } /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .gallery-thumb { margin: 2px; } /* –û—Ç—Å—Ç—É–ø—ã –º–∏–Ω–∏–∞—Ç—é—Ä */
    .gallery-thumb.active { border-width: 2px !important; } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –º–∏–Ω–∏–∞—Ç—é—Ä—ã */
  </style> <!-- –ö–æ–Ω–µ—Ü –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ç–∏–ª–µ–π -->
</head> <!-- –ö–æ–Ω–µ—Ü —à–∞–ø–∫–∏ -->
<body class="pb-5"> <!-- –¢–µ–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  {% include 'partials/gallery.html' %} <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â—É—é —Ä–∞–∑–º–µ—Ç–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–∞–ª–µ—Ä–µ–∏ -->
  <div class="container py-4"> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4 glass shadow-soft p-4"> <!-- –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
      <div class="d-flex align-items-center gap-3"> <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å —Å –∞–≤–∞—Ç–∞—Ä–æ–º -->
        {% if payload.summary.peer_avatar or payload.summary.from_avatar %} <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <img src="{{ payload.summary.peer_avatar or payload.summary.from_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-lg" /> <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä -->
        {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <div class="avatar-lg d-flex align-items-center justify-content-center bg-dark text-secondary">‚Äî</div> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
        {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <div> <!-- –ë–ª–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
          <div class="d-inline-flex align-items-center gap-2 mb-2"> <!-- –°—Ç—Ä–æ–∫–∞ –±–µ–π–¥–∂–µ–π -->
            <span class="badge-soft badge rounded-pill"> <!-- –ë–µ–π–¥–∂ —Ç–∏–ø–∞ —Å—É—â–Ω–æ—Å—Ç–∏ -->
              {{ '–ü—Ä–æ—Ñ–∏–ª—å —á–∞—Ç–∞' if entity_type == 'chat' else '–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }} <!-- –ü–æ–¥–ø–∏—Å—å –±–µ–π–¥–∂–∞ -->
            </span> <!-- –ö–æ–Ω–µ—Ü –±–µ–π–¥–∂–∞ -->
            {% if demo_mode %} <!-- –ï—Å–ª–∏ –¥–µ–º–æ-—Ä–µ–∂–∏–º -->
            <span class="badge bg-warning text-dark">–î–µ–º–æ</span> <!-- –ë–µ–π–¥–∂ –¥–µ–º–æ -->
            {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–º–æ -->
          </div> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –±–µ–π–¥–∂–µ–π -->
          <h1 class="fw-bold mb-1">{{ payload.summary.peer_title or payload.summary.from_name }}</h1> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º -->
          <p class="text-secondary mb-0">ID: {{ payload.summary.peer_id or payload.summary.from_id }} ‚Ä¢ –õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π: {{ limit }}</p> <!-- –ü–æ–¥–ø–∏—Å—å —Å ID –∏ –ª–∏–º–∏—Ç–æ–º -->
        </div> <!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ -->
      <div class="d-flex flex-wrap gap-2"> <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
        <a href="/" class="btn btn-outline-light">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–∞—à–±–æ—Ä–¥—É</a> <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <a href="/logs/full" class="btn btn-outline-light">–ö –ª–æ–≥–∞–º</a> <!-- –ö–Ω–æ–ø–∫–∞ –ª–æ–≥–æ–≤ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ -->
    </div> <!-- –ö–æ–Ω–µ—Ü —à–∞–ø–∫–∏ -->

    <div class="row g-3 mb-4"> <!-- –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.total_messages }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ -->
          <div class="text-secondary small">–í—Å–µ –∑–∞–ø–∏—Å–∏, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –±–∞–∑–µ</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">{{ '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π' if entity_type == 'chat' else '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤' }}</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.unique_senders if entity_type == 'chat' else payload.summary.unique_peers }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ -->
          <div class="text-secondary small">–°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è —Ç–∏–ø–∞ message</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –¢—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1" data-time>{{ payload.summary.last_message_time or '‚Äî' }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ -->
          <div class="text-secondary small">–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
    </div> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->

    <div class="glass shadow-soft p-4"> <!-- –ë–ª–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π -->
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ -->
        <div> <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å -->
          <div class="card-title mb-1">–°–æ–æ–±—â–µ–Ω–∏—è</div> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <div class="text-secondary small">–°–≤–µ–∂–∏–µ –∑–∞–ø–∏—Å–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
        </div> <!-- –ö–æ–Ω–µ—Ü –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ -->
        <div class="d-flex align-items-center gap-2"> <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å -->
          <span class="badge-soft badge rounded-pill">READ ONLY</span> <!-- –ë–µ–π–¥–∂ —Ä–µ–∂–∏–º–∞ -->
          <span class="badge-soft badge rounded-pill">–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</span> <!-- –ë–µ–π–¥–∂ —Ç–∞–π–º–∑–æ–Ω—ã -->
        </div> <!-- –ö–æ–Ω–µ—Ü –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
      <div class="table-responsive"> <!-- –û–±–µ—Ä—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
        {% set show_chat_column = entity_type != 'chat' %} <!-- –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ (—Å–∫—Ä—ã–≤–∞–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ —á–∞—Ç–∞) -->
        {% set show_sender_column = entity_type == 'chat' %} <!-- –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (—Å–∫—Ä—ã–≤–∞–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ —á–µ–ª–æ–≤–µ–∫–∞) -->
        {% set column_count = 3 + (1 if show_chat_column else 0) + (1 if show_sender_column else 0) %} <!-- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ colspan -->
        <table class="table table-striped align-middle mb-0"> <!-- –¢–∞–±–ª–∏—Ü–∞ -->
          <thead class="text-secondary"> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
            <tr> <!-- –°—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ -->
              <th>–í—Ä–µ–º—è</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
              {% if show_chat_column %} <!-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü —á–∞—Ç–∞ -->
              <th>–ß–∞—Ç</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ —á–∞—Ç–∞ -->
              {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ -->
              {% if show_sender_column %} <!-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
              <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –∞–≤—Ç–æ—Ä–∞ -->
              {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
              <th>–í–ª–æ–∂–µ–Ω–∏—è</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π -->
              <th>–¢–µ–∫—Å—Ç</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ —Ç–µ–∫—Å—Ç–∞ -->
            </tr> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ -->
          </thead> <!-- –ö–æ–Ω–µ—Ü –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
          <tbody> <!-- –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã -->
            {% if not payload.messages %} <!-- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö -->
            <tr> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ -->
              <td colspan="{{ column_count }}" class="text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td> <!-- –¢–µ–∫—Å—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤ -->
            </tr> <!-- –ö–æ–Ω–µ—Ü –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ -->
            {% else %} <!-- –í–µ—Ç–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
              {% for message in payload.messages %} <!-- –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è -->
              <tr> <!-- –°—Ç—Ä–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                {% set gallery_key = 'entity-msg-' ~ loop.index0 %} <!-- –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ -->
                <td data-time>{{ message.created_at or '‚Äî' }}</td> <!-- –Ø—á–µ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
                {% if show_chat_column %} <!-- –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü —á–∞—Ç–∞ -->
                <td> <!-- –Ø—á–µ–π–∫–∞ —á–∞—Ç–∞ -->
                  {% if message.peer_id %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å peer_id -->
                  <a href="/chat/{{ message.peer_id }}" target="_blank" class="text-decoration-none text-light d-inline-flex align-items-center gap-2"> <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç -->
                    {% if message.peer_avatar %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä -->
                    <img src="{{ message.peer_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-inline" /> <!-- –ê–≤–∞—Ç–∞—Ä —á–∞—Ç–∞ -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
                    <span>{{ message.peer_title or '–ß–∞—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</span> <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ -->
                  </a> <!-- –ö–æ–Ω–µ—Ü —Å—Å—ã–ª–∫–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ peer_id -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ peer_id -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ —á–∞—Ç–∞ -->
                {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ -->
                {% if show_sender_column %} <!-- –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                <td> <!-- –Ø—á–µ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                  {% if message.from_id %} <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                  <a href="/user/{{ message.from_id }}" target="_blank" class="text-decoration-none text-light d-inline-flex align-items-center gap-2 flex-wrap"> <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    {% if message.from_avatar %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä -->
                    <img src="{{ message.from_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-inline" /> <!-- –ê–≤–∞—Ç–∞—Ä -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
                    <span>{{ message.from_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å' }}</span> <!-- –ò–º—è -->
                    {% if message.is_bot %} <!-- –ï—Å–ª–∏ —ç—Ç–æ –±–æ—Ç -->
                    <span class="badge bg-info text-dark">–ë–æ—Ç</span> <!-- –ü–ª–∞—à–∫–∞ –±–æ—Ç–∞ -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–æ—Ç–∞ -->
                  </a> <!-- –ö–æ–Ω–µ—Ü —Å—Å—ã–ª–∫–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ from_id -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                <td> <!-- –Ø—á–µ–π–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  {% set attachment_count = message.attachments|length if message.attachments else 0 %} <!-- –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  {% if attachment_count > 0 %} <!-- –ï—Å–ª–∏ –≤–ª–æ–∂–µ–Ω–∏—è –µ—Å—Ç—å -->
                  <span class="attachment-pill attachment-generic" data-gallery-key="{{ gallery_key }}">üìé {{ attachment_count }}</span> <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä–µ–ø–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π —Å –∫–ª—é—á–æ–º –≥–∞–ª–µ—Ä–µ–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π -->
                <td>{{ message.text or '‚Äî' }}</td> <!-- –Ø—á–µ–π–∫–∞ —Ç–µ–∫—Å—Ç–∞ -->
              </tr> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
              {% endfor %} <!-- –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö -->
          </tbody> <!-- –ö–æ–Ω–µ—Ü —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã -->
        </table> <!-- –ö–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã -->
      </div> <!-- –ö–æ–Ω–µ—Ü –æ–±–µ—Ä—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->


    </div> <!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
  </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->

  <script> // –ù–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    const timeCells = document.querySelectorAll('[data-time]'); // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –¥–∞—Ç–∞–º–∏
    const formatter = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'medium' }); // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    timeCells.forEach((cell) => { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const iso = cell.textContent.trim(); // –ë–µ—Ä–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É
      const parsed = iso ? new Date(iso) : null; // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
      cell.textContent = parsed && !Number.isNaN(parsed.valueOf()) ? formatter.format(parsed) : '‚Äî'; // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    }); // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞

    const galleryModal = document.getElementById('gallery-modal'); // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ–Ω –º–æ–¥–∞–ª–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
    const galleryStrip = document.getElementById('gallery-strip'); // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–æ—Å—É –º–∏–Ω–∏–∞—Ç—é—Ä
    const galleryMedia = document.getElementById('gallery-media'); // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ–¥–∏–∞
    const galleryCaption = document.getElementById('gallery-caption'); // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥–ø–∏—Å—å —Ñ–∞–π–ª–∞
    const galleryOrigin = document.getElementById('gallery-origin'); // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥–ø–∏—Å—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    const galleryLinks = document.getElementById('gallery-links'); // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ —Å—Å—ã–ª–æ–∫
    const galleryPrev = document.getElementById('gallery-prev'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É ¬´–Ω–∞–∑–∞–¥¬ª
    const galleryNext = document.getElementById('gallery-next'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É ¬´–≤–ø–µ—Ä–µ–¥¬ª
    const galleryClose = document.getElementById('gallery-close'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
    const serverMessages = {{ payload.messages | tojson }}; // –ó–∞–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
    let galleryStore = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≥–∞–ª–µ—Ä–µ–π –ø–æ –∫–ª—é—á—É
    let currentGalleryKey = null; // –¢–µ–∫—É—â–∏–π –∫–ª—é—á –æ—Ç–∫—Ä—ã—Ç–æ–π –≥–∞–ª–µ—Ä–µ–∏
    let currentGalleryIndex = 0; // –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–ª–æ–∂–µ–Ω–∏—è

    function isVideoType(type) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–∏–ø –≤–∏–¥–µ–æ
      return ['video', 'story'].includes(type); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —Å–ø–∏—Å–∫—É —Ç–∏–ø–æ–≤
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–µ–æ

    function normalizeAttachmentLink(att) { // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–ª–æ–∂–µ–Ω–∏–µ
      if (!att) { // –ï—Å–ª–∏ –≤–ª–æ–∂–µ–Ω–∏—è –Ω–µ—Ç
        return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      if (att.url) { // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä—è–º–æ–π url
        return att.url; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º url
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏
      if (att.public_url) { // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞
        return att.public_url; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏
      if (att.photo && att.photo.sizes && att.photo.sizes.length) { // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ç–æ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–∞–∑–º–µ—Ä–æ–≤
        const sorted = [...att.photo.sizes].sort((a, b) => b.width - a.width); // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–æ —à–∏—Ä–∏–Ω–µ
        return sorted[0]?.url || null; // –ë–µ—Ä–µ–º —Å–∞–º—ã–π —à–∏—Ä–æ–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ç–æ
      if (att.video && att.video.player) { // –ï—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ —Å –ø–æ–ª–µ–º player
        return att.video.player; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–ª–µ–µ—Ä
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–µ–æ
      return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏

    function normalizeAttachmentItem(att, originLabel) { // –ü—Ä–∏–≤–æ–¥–∏–º –≤–ª–æ–∂–µ–Ω–∏–µ –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É
      const type = att?.type || 'file'; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø
      const url = normalizeAttachmentLink(att); // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É
      const caption = att?.title || att?.name || att?.doc?.title || att?.link?.title || att?.photo?.text || att?.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'; // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å
      if (!url) { // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç
        return null; // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –≥–∞–ª–µ—Ä–µ—é
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–∫–∏
      return { // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ
        url, // –ü–æ–ª–µ —Å—Å—ã–ª–∫–∏
        type, // –¢–∏–ø –≤–ª–æ–∂–µ–Ω–∏—è
        caption, // –ü–æ–¥–ø–∏—Å—å —Ñ–∞–π–ª–∞
        origin: originLabel || '–°–æ–æ–±—â–µ–Ω–∏–µ', // –ò—Å—Ç–æ—á–Ω–∏–∫
      }; // –ö–æ–Ω–µ—Ü –æ–±—ä–µ–∫—Ç–∞
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

    function registerGallery(items, galleryKey, originLabel) { // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–∞–ª–µ—Ä–µ—é –ø–æ –∫–ª—é—á—É
      if (!Array.isArray(items) || !items.length) { // –ï—Å–ª–∏ –≤–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç
        return; // –í—ã—Ö–æ–¥–∏–º –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π
      const normalized = items // –ü—Ä–∏–≤–æ–¥–∏–º –≤–ª–æ–∂–µ–Ω–∏—è –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É
        .map((att) => normalizeAttachmentItem(att, originLabel)) // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–∂–¥–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ
        .filter(Boolean); // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ
      if (!normalized.length) { // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—É—Å—Ç–æ
        return; // –í—ã—Ö–æ–¥–∏–º
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞
      galleryStore[galleryKey] = { items: normalized, meta: { peer: originLabel || '–°–æ–æ–±—â–µ–Ω–∏–µ' } }; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–∞–ª–µ—Ä–µ—é –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

    function renderGalleryStrip(galleryData) { // –†–∏—Å—É–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≥–∞–ª–µ—Ä–µ–∏
      if (!galleryData || !Array.isArray(galleryData.items) || galleryData.items.length === 0) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        galleryStrip.innerHTML = '<span class="text-secondary small">–í–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç</span>'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      const buttons = galleryData.items.map((item, idx) => { // –°—Ç—Ä–æ–∏–º –∫–Ω–æ–ø–∫–∏
        const label = item.type || '–§–∞–π–ª'; // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—å —Ç–∏–ø–∞
        const activeClass = idx === currentGalleryIndex ? 'active' : ''; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
        return `<button type="button" class="btn btn-outline-light btn-sm gallery-thumb ${activeClass}" data-gallery-index="${idx}">${idx + 1}. ${label}</button>`; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML –∫–Ω–æ–ø–∫–∏
      }); // –ö–æ–Ω–µ—Ü —Å–±–æ—Ä–∫–∏ –∫–Ω–æ–ø–æ–∫
      galleryStrip.innerHTML = buttons.join(''); // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≤ DOM
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–æ—Å—ã –º–∏–Ω–∏–∞—Ç—é—Ä

    function renderGallerySlide(galleryData, index) { // –†–∏—Å—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ
      if (!galleryData || !Array.isArray(galleryData.items) || galleryData.items.length === 0) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
        galleryMedia.innerHTML = '<div class="text-secondary">–í–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç</div>'; // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –º–µ–¥–∏–∞
        galleryCaption.textContent = '‚Äî'; // –û—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å—å
        galleryOrigin.textContent = '–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
        galleryLinks.innerHTML = '‚Äî'; // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫–∏
        return; // –í—ã—Ö–æ–¥–∏–º
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      const boundedIndex = Math.max(0, Math.min(index, galleryData.items.length - 1)); // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–π –∏–Ω–¥–µ–∫—Å
      currentGalleryIndex = boundedIndex; // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
      const item = galleryData.items[boundedIndex]; // –ë–µ—Ä–µ–º –Ω—É–∂–Ω–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ
      const isVideo = isVideoType(item.type); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–æ –ª–∏ —ç—Ç–æ
      const mediaHtml = isVideo ? `<video controls src="${item.url}" class="w-100" preload="metadata"></video>` : `<img src="${item.url}" alt="–í–ª–æ–∂–µ–Ω–∏–µ" loading="lazy" />`; // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –º–µ–¥–∏–∞
      galleryMedia.innerHTML = mediaHtml; // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞
      galleryCaption.textContent = item.caption || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
      galleryOrigin.textContent = item.origin || galleryData.meta.peer || '–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'; // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
      galleryLinks.innerHTML = `<a href="${item.url}" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª</a>`; // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
      renderGalleryStrip(galleryData); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ —Å–ª–∞–π–¥–∞

    function openGallery(key, index = 0) { // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
      const galleryData = galleryStore[key]; // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–ª—é—á—É
      if (!galleryData) { // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        return; // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      currentGalleryKey = key; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–ª—é—á
      renderGallerySlide(galleryData, index); // –†–∏—Å—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–∞–π–¥
      galleryModal.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è

    function closeGallery() { // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
      galleryModal.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      currentGalleryKey = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª—é—á
      currentGalleryIndex = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

    function moveGallery(delta) { // –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
      if (!currentGalleryKey || !galleryStore[currentGalleryKey]) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—á–µ–≥–æ –ª–∏—Å—Ç–∞—Ç—å
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      const galleryData = galleryStore[currentGalleryKey]; // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      const nextIndex = (currentGalleryIndex + delta + galleryData.items.length) % galleryData.items.length; // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –∫—Ä—É–≥—É
      renderGallerySlide(galleryData, nextIndex); // –†–∏—Å—É–µ–º –Ω–æ–≤—ã–π —Å–ª–∞–π–¥
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è

    function prepareGalleries() { // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –≥–∞–ª–µ—Ä–µ–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
      (serverMessages || []).forEach((msg, idx) => { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        const galleryKey = `entity-msg-${idx}`; // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á
        registerGallery(msg.attachments || [], galleryKey, msg.peer_title || msg.from_name || '–°–æ–æ–±—â–µ–Ω–∏–µ'); // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–ª–æ–∂–µ–Ω–∏—è
      }); // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

    function bindGalleryTriggers() { // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —Å–∫—Ä–µ–ø–∫–∏
      document.querySelectorAll('[data-gallery-key]').forEach((node) => { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ —Å–∫—Ä–µ–ø–∫–æ–π
        node.addEventListener('click', (event) => { // –°–ª—É—à–∞–µ–º –∫–ª–∏–∫
          event.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
          const key = node.getAttribute('data-gallery-key'); // –ó–∞–±–∏—Ä–∞–µ–º –∫–ª—é—á –≥–∞–ª–µ—Ä–µ–∏
          openGallery(key, 0); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≤–ª–æ–∂–µ–Ω–∏–µ
        }); // –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞
      }); // –ö–æ–Ω–µ—Ü –ø–µ—Ä–µ–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –±–∏–Ω–¥–∏–Ω–≥–∞

    galleryPrev.addEventListener('click', () => moveGallery(-1)); // –õ–∏—Å—Ç–∞–µ–º –Ω–∞–∑–∞–¥ –ø–æ –∫–ª–∏–∫—É
    galleryNext.addEventListener('click', () => moveGallery(1)); // –õ–∏—Å—Ç–∞–µ–º –≤–ø–µ—Ä–µ–¥ –ø–æ –∫–ª–∏–∫—É
    galleryClose.addEventListener('click', closeGallery); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ –∫–Ω–æ–ø–∫–µ
    galleryStrip.addEventListener('click', (event) => { // –°–ª—É—à–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º
      const target = event.target.closest('[data-gallery-index]'); // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –º–∏–Ω–∏–∞—Ç—é—Ä—ã
      if (!target) { // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ
        return; // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      const index = Number(target.getAttribute('data-gallery-index')); // –ó–∞–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å
      if (Number.isNaN(index)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
        return; // –í—ã—Ö–æ–¥–∏–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω–¥–µ–∫—Å–∞
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      const galleryData = galleryStore[currentGalleryKey]; // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≥–∞–ª–µ—Ä–µ–∏
      if (!galleryData) { // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
        return; // –í—ã—Ö–æ–¥–∏–º
      } // –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏
      renderGallerySlide(galleryData, index); // –†–∏—Å—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–∞–π–¥
    }); // –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º

    prepareGalleries(); // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    bindGalleryTriggers(); // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —Å–∫—Ä–µ–ø–∫–∏
  </script> <!-- –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞ -->
</body> <!-- –ö–æ–Ω–µ—Ü —Ç–µ–ª–∞ -->
</html> <!-- –ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
