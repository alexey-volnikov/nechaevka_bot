<!doctype html> <!-- Объявляем тип документа -->
<html lang="ru"> <!-- Устанавливаем язык страницы -->
<head> <!-- Начало шапки -->
  <meta charset="UTF-8" /> <!-- Кодировка -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Адаптивность -->
  <title>Профиль {{ 'чата' if entity_type == 'chat' else 'пользователя' }}</title> <!-- Заголовок вкладки -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" /> <!-- Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com" /> <!-- Предзагрузка шрифтов -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- Кросс-домен для шрифтов -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" /> <!-- Шрифт Inter -->
  <style> /* Начало пользовательских стилей */
    body { background: #0f172a; color: #e2e8f0; font-family: "Inter", system-ui, -apple-system, sans-serif; } /* Фон и текст */
    .glass { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; backdrop-filter: blur(10px); } /* Стеклянный стиль */
    .shadow-soft { box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25); } /* Мягкая тень */
    .badge-soft { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; border: 1px solid rgba(99, 102, 241, 0.35); } /* Мягкий бейдж */
    .avatar-lg { width: 64px; height: 64px; border-radius: 16px; object-fit: cover; } /* Крупный аватар */
    .avatar-inline { width: 1.6em; height: 1.6em; border-radius: 999px; object-fit: cover; flex-shrink: 0; } /* Компактный аватар */
    .stat-card { min-height: 140px; } /* Минимальная высота карточки статистики */
    .attachment-pill { display: inline-flex; gap: 6px; align-items: center; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(255, 255, 255, 0.05); color: #e2e8f0; font-size: 12px; text-decoration: none; } /* Пилюля вложения */
    .attachment-pill:hover { text-decoration: none; background: rgba(255, 255, 255, 0.08); } /* Подсветка вложения */
    .attachment-pending { border-style: dashed; background: rgba(59, 130, 246, 0.18); color: #cbd5e1; } /* Подсветка ожидания загрузки вложения */
    .attachment-failed { border-style: dashed; background: rgba(248, 113, 113, 0.2); color: #fecaca; border-color: rgba(248, 113, 113, 0.5); } /* Подсветка ошибок скачивания */
    .attachment-photo { border-color: rgba(59, 130, 246, 0.5); color: #bfdbfe; } /* Цвет фото */
    .attachment-video { border-color: rgba(244, 114, 182, 0.5); color: #fbcfe8; } /* Цвет видео */
    .attachment-doc { border-color: rgba(74, 222, 128, 0.5); color: #bbf7d0; } /* Цвет документа */
    .attachment-link { border-color: rgba(14, 165, 233, 0.5); color: #bae6fd; } /* Цвет ссылки */
    .attachment-audio { border-color: rgba(56, 189, 248, 0.5); color: #bae6fd; } /* Цвет аудио */
    .attachment-sticker { border-color: rgba(248, 180, 0, 0.6); color: #fef08a; } /* Цвет стикера */
    .attachment-generic { border-color: rgba(148, 163, 184, 0.5); color: #e2e8f0; } /* Цвет прочего */
    .table > :not(caption) > * > * { background-color: transparent; color: #e2e8f0; } /* Прозрачные ячейки */
    .table-striped > tbody > tr:nth-of-type(odd) > * { background: rgba(255, 255, 255, 0.03); } /* Полосатость */
    .text-secondary-small { color: #94a3b8; font-size: 13px; } /* Серый мелкий текст */
    .gallery-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 16px; } /* Затемненный фон галереи */
    .gallery-body { background: #0b1220; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; max-width: 900px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35); display: flex; flex-direction: column; gap: 12px; padding: 16px; } /* Контейнер галереи */
    .gallery-media { position: relative; min-height: 320px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.03); border-radius: 12px; overflow: hidden; } /* Блок медиа */
    .gallery-media img, .gallery-media video { max-height: 540px; width: 100%; object-fit: contain; border-radius: 12px; background: #0b1220; } /* Медиа внутри галереи */
    .gallery-actions { display: flex; align-items: center; justify-content: space-between; gap: 12px; } /* Панель действий галереи */
    .gallery-meta { display: flex; flex-direction: column; gap: 4px; font-size: 14px; color: #cbd5e1; } /* Метаданные выбранного вложения */
    .gallery-nav-btn { min-width: 42px; } /* Минимальная ширина кнопок навигации */
    .gallery-thumb { margin: 2px; } /* Отступы миниатюр */
    .gallery-thumb.active { border-width: 2px !important; } /* Подсветка активной миниатюры */
  </style> <!-- Конец пользовательских стилей -->
</head> <!-- Конец шапки -->
<body class="pb-5"> <!-- Тело страницы -->
  {% include 'partials/gallery.html' %} <!-- Подключаем общую разметку модального окна галереи -->
  <div class="container py-4"> <!-- Контейнер -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4 glass shadow-soft p-4"> <!-- Шапка профиля -->
      <div class="d-flex align-items-center gap-3"> <!-- Левая часть с аватаром -->
        {% if payload.summary.peer_avatar or payload.summary.from_avatar %} <!-- Проверяем наличие аватара -->
        <img src="{{ payload.summary.peer_avatar or payload.summary.from_avatar }}" alt="Аватар" class="avatar-lg" /> <!-- Показываем аватар -->
        {% else %} <!-- Ветка без аватара -->
        <div class="avatar-lg d-flex align-items-center justify-content-center bg-dark text-secondary">—</div> <!-- Плейсхолдер -->
        {% endif %} <!-- Конец проверки аватара -->
        <div> <!-- Блок заголовка -->
          <div class="d-inline-flex align-items-center gap-2 mb-2"> <!-- Строка бейджей -->
            <span class="badge-soft badge rounded-pill"> <!-- Бейдж типа сущности -->
              {{ 'Профиль чата' if entity_type == 'chat' else 'Профиль пользователя' }} <!-- Подпись бейджа -->
            </span> <!-- Конец бейджа -->
            {% if demo_mode %} <!-- Если демо-режим -->
            <span class="badge bg-warning text-dark">Демо</span> <!-- Бейдж демо -->
            {% endif %} <!-- Конец проверки демо -->
          </div> <!-- Конец строки бейджей -->
          <h1 class="fw-bold mb-1">{{ payload.summary.peer_title or payload.summary.from_name }}</h1> <!-- Заголовок с именем -->
          <p class="text-secondary mb-0">ID: {{ payload.summary.peer_id or payload.summary.from_id }} • Лента листается без лимита</p> <!-- Подпись с ID и информацией о бесконечной ленте -->
        </div> <!-- Конец блока заголовка -->
      </div> <!-- Конец левой части -->
      <div class="d-flex flex-wrap gap-2"> <!-- Правая часть с кнопками -->
        <a href="/" class="btn btn-outline-light">Вернуться к дашборду</a> <!-- Кнопка назад -->
        <a href="/logs/full" class="btn btn-outline-light">К логам</a> <!-- Кнопка логов -->
      </div> <!-- Конец правой части -->
    </div> <!-- Конец шапки -->

    <div class="row g-3 mb-4"> <!-- Строка статистики -->
      <div class="col-12 col-md-4"> <!-- Первая карточка -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- Карточка -->
          <div class="text-secondary-small">Всего сообщений</div> <!-- Подпись -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.total_messages }}</div> <!-- Значение -->
          <div class="text-secondary small">Все записи, найденные в базе</div> <!-- Подпись уточнения -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-md-4"> <!-- Вторая карточка -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- Карточка -->
          <div class="text-secondary-small">{{ 'Уникальных отправителей' if entity_type == 'chat' else 'Уникальных чатов' }}</div> <!-- Подпись -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.unique_senders if entity_type == 'chat' else payload.summary.unique_peers }}</div> <!-- Значение -->
          <div class="text-secondary small">Считаем только события типа message</div> <!-- Подпись уточнения -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-md-4"> <!-- Третья карточка -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- Карточка -->
          <div class="text-secondary-small">Последнее сообщение</div> <!-- Подпись -->
          <div class="h3 fw-bold mb-1" data-time>{{ payload.summary.last_message_time or '—' }}</div> <!-- Значение времени -->
          <div class="text-secondary small">Локальное время браузера</div> <!-- Подпись уточнения -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
    </div> <!-- Конец строки статистики -->

    <div class="glass shadow-soft p-4"> <!-- Блок таблицы сообщений -->
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"> <!-- Заголовок блока -->
        <div> <!-- Левая часть -->
          <div class="card-title mb-1">Сообщения</div> <!-- Заголовок -->
          <div class="text-secondary small">Свежие записи выводятся первыми</div> <!-- Подпись -->
        </div> <!-- Конец левой части -->
        <div class="d-flex align-items-center gap-2"> <!-- Правая часть -->
          <span class="badge-soft badge rounded-pill">READ ONLY</span> <!-- Бейдж режима -->
          <span class="badge-soft badge rounded-pill">Локальное время</span> <!-- Бейдж таймзоны -->
        </div> <!-- Конец правой части -->
      </div> <!-- Конец заголовка -->
      <div class="table-responsive"> <!-- Обертка таблицы -->
        {% set show_chat_column = entity_type != 'chat' %} <!-- Флаг отображения столбца чата (скрываем в профиле чата) -->
        {% set show_sender_column = entity_type == 'chat' %} <!-- Флаг отображения столбца отправителя (скрываем в профиле человека) -->
        {% set column_count = 3 + (1 if show_chat_column else 0) + (1 if show_sender_column else 0) %} <!-- Рассчитываем количество столбцов для корректного colspan -->
        <table class="table table-striped align-middle mb-0"> <!-- Таблица -->
          <thead class="text-secondary"> <!-- Заголовок таблицы -->
            <tr> <!-- Строка заголовков -->
              <th>Время</th> <!-- Колонка времени -->
              {% if show_chat_column %} <!-- Если нужно показать столбец чата -->
              <th>Чат</th> <!-- Колонка чата -->
              {% endif %} <!-- Конец проверки столбца чата -->
              {% if show_sender_column %} <!-- Если нужно показать столбец отправителя -->
              <th>Отправитель</th> <!-- Колонка автора -->
              {% endif %} <!-- Конец проверки столбца отправителя -->
              <th>Вложения</th> <!-- Колонка вложений -->
              <th>Текст</th> <!-- Колонка текста -->
            </tr> <!-- Конец строки заголовков -->
          </thead> <!-- Конец заголовка -->
          <tbody id="messages-body"> <!-- Тело таблицы с идентификатором для скрипта рендера -->
            <tr id="messages-placeholder"> <!-- Плейсхолдер пустой таблицы -->
              <td colspan="{{ column_count }}" class="text-secondary">Нет данных</td> <!-- Текст плейсхолдера с динамическим количеством столбцов -->
            </tr> <!-- Конец плейсхолдера -->
          </tbody> <!-- Конец тела таблицы -->
        </table> <!-- Конец таблицы -->
      </div> <!-- Конец обертки таблицы -->


    </div> <!-- Конец блока таблицы -->
  </div> <!-- Конец контейнера -->

  <script src="{{ url_for('static', filename='js/gallery.js') }}"></script> <!-- Подключаем общий скрипт галереи -->
  <script src="{{ url_for('static', filename='js/chat-history.js') }}"></script> <!-- Подключаем единый модуль истории чата -->
  <script> // Начало скрипта динамической таблицы
    const tableBody = document.getElementById('messages-body'); // Находим тело таблицы сообщений
    const galleryApi = window.galleryBridge || {}; // Подготавливаем общий API галереи
    const chatApi = window.chatHistory || {}; // Подготавливаем единый модуль истории чата
    const serverMessages = {{ payload.messages | tojson }}; // Забираем стартовые сообщения с вложениями из шаблона
    const showChatColumn = {{ 'true' if show_chat_column else 'false' }}; // Флаг отображения столбца чата
    const showSenderColumn = {{ 'true' if show_sender_column else 'false' }}; // Флаг отображения столбца отправителя
    const formatter = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'medium' }); // Настраиваем формат локального времени
    const pageSize = {{ page_size | tojson }}; // Размер страницы для постраничной подгрузки
    const basePeerId = {{ payload.summary.peer_id | tojson }}; // Фильтр по чату для API
    const baseFromId = {{ payload.summary.from_id | tojson }}; // Фильтр по отправителю для API
    let galleryCounter = 0; // Счетчик ключей галереи для стабильных идентификаторов
    let currentOffset = Array.isArray(serverMessages) ? serverMessages.length : 0; // Текущее смещение для следующей подгрузки
    let isLoading = false; // Флаг состояния загрузки
    let hasMore = Array.isArray(serverMessages) && serverMessages.length === pageSize; // Флаг наличия следующих страниц

    const formatDate = (value) => { // Готовим вспомогательную функцию форматирования дат
      const parsed = value ? new Date(value) : null; // Парсим дату из строки
      const validDate = parsed && !Number.isNaN(parsed.valueOf()); // Проверяем валидность даты
      return validDate ? formatter.format(parsed) : '—'; // Возвращаем отформатированную дату или плейсхолдер
    }; // Конец функции форматирования даты

    const resetGalleryStore = () => { // Очищаем хранилище галереи перед полной перерисовкой
      if (galleryApi.resetGalleryStorePreserveActive) { // Проверяем наличие функции сброса
        galleryApi.resetGalleryStorePreserveActive(); // Очищаем галерею, сохраняя активное состояние
      } // Конец проверки наличия функции сброса
    }; // Конец вспомогательной функции

    const renderMessages = (messages, { append = false } = {}) => { // Функция отрисовки строк таблицы с поддержкой дописывания
      if (!append) { // Если требуется полная перерисовка
        tableBody.innerHTML = ''; // Очищаем тело таблицы
        resetGalleryStore(); // Очищаем хранилище галереи
        galleryCounter = 0; // Сбрасываем счетчик ключей галереи
      } // Конец проверки режима перерисовки
      if (!Array.isArray(messages) || messages.length === 0) { // Проверяем наличие данных
        if (!append) { // Отрисовываем плейсхолдер только при полном режиме
          const emptyRow = document.createElement('tr'); // Создаем строку для плейсхолдера
          emptyRow.id = 'messages-placeholder'; // Добавляем идентификатор плейсхолдера
          emptyRow.innerHTML = `<td colspan="{{ column_count }}" class="text-secondary">Нет данных</td>`; // Подставляем текст плейсхолдера
          tableBody.appendChild(emptyRow); // Добавляем строку в таблицу
        } // Конец проверки режима
        return; // Завершаем выполнение при отсутствии данных
      } // Конец проверки наличия данных
      if (append) { // Если добавляем новые записи к существующим
        const placeholderRow = document.getElementById('messages-placeholder'); // Пытаемся найти плейсхолдер пустой таблицы
        if (placeholderRow) { // Если плейсхолдер найден
          placeholderRow.remove(); // Удаляем его перед добавлением настоящих данных
        } // Конец проверки наличия плейсхолдера
      } // Конец проверки режима добавления
      messages.forEach((msg) => { // Перебираем все сообщения
        const galleryKey = `entity-msg-${galleryCounter++}`; // Формируем уникальный ключ галереи
        const row = chatApi.buildEntityRow(msg, galleryApi, galleryKey, { // Сборка строки через единый модуль истории чата
          showChatColumn, // Передаем флаг столбца чата
          showSenderColumn, // Передаем флаг столбца отправителя
          formatDate, // Передаем функцию форматирования времени
        }); // Завершаем сборку строки
        tableBody.appendChild(row); // Добавляем готовую строку в таблицу
      }); // Конец перебора сообщений
    }; // Конец функции рендера

    const buildQueryParams = (offsetValue) => { // Формируем объект параметров для API
      const params = { limit: pageSize, offset: offsetValue }; // Добавляем лимит и смещение
      if (Number.isFinite(basePeerId)) { // Проверяем наличие фильтра чата
        params.peer_id = basePeerId; // Добавляем peer_id в параметры
      } // Конец проверки фильтра чата
      if (Number.isFinite(baseFromId)) { // Проверяем наличие фильтра отправителя
        params.from_id = baseFromId; // Добавляем from_id в параметры
      } // Конец проверки фильтра отправителя
      return params; // Возвращаем собранные параметры
    }; // Конец функции формирования параметров

    const fetchLogs = async (params) => { // Функция запроса логов с сервера
      const searchParams = new URLSearchParams(params); // Формируем строку запроса
      const response = await fetch(`/api/logs?${searchParams.toString()}`); // Выполняем запрос к API логов
      const data = await response.json(); // Читаем JSON-ответ
      return data.items || []; // Возвращаем список сообщений
    }; // Конец функции запроса логов

    const loadMoreMessages = async () => { // Функция подгрузки следующей страницы
      if (isLoading || !hasMore) { // Проверяем, можно ли начинать загрузку
        return; // Прерываем, если уже загружаем или данные закончились
      } // Конец проверки возможности загрузки
      isLoading = true; // Ставим флаг загрузки
      try { // Блок попытки запроса
        const params = buildQueryParams(currentOffset); // Формируем параметры запроса
        const nextChunk = await fetchLogs(params); // Запрашиваем следующую страницу логов
        if (Array.isArray(nextChunk) && nextChunk.length > 0) { // Проверяем, что пришли данные
          renderMessages(nextChunk, { append: true }); // Добавляем новые строки в таблицу
          currentOffset += nextChunk.length; // Увеличиваем смещение
          hasMore = nextChunk.length === pageSize; // Обновляем флаг наличия данных
        } else { // Если новые данные не пришли
          hasMore = false; // Помечаем, что дальше загружать нечего
        } // Конец проверки полученных данных
      } catch (err) { // Обработка ошибок запроса
        console.error('Не удалось подгрузить сообщения', err); // Пишем ошибку в консоль
        hasMore = false; // Останавливаем дальнейшие попытки при ошибке
      } finally { // Блок завершения
        isLoading = false; // Сбрасываем флаг загрузки
      } // Конец блока завершения
    }; // Конец функции подгрузки

    const handleScroll = () => { // Обработчик прокрутки страницы
      const scrollPosition = window.scrollY + window.innerHeight; // Текущая позиция прокрутки
      const threshold = document.documentElement.scrollHeight - 400; // Порог, при достижении которого начинаем подгрузку
      if (scrollPosition >= threshold) { // Проверяем, достигнут ли порог
        loadMoreMessages(); // Запускаем подгрузку следующей страницы
      } // Конец проверки порога
    }; // Конец обработчика прокрутки

    renderMessages(serverMessages || [], { append: false }); // Рисуем стартовую таблицу сразу после загрузки страницы
    window.addEventListener('scroll', handleScroll); // Подписываемся на прокрутку для бесконечной ленты
    if (hasMore) { // Если есть данные для подгрузки
      loadMoreMessages(); // Запрашиваем следующую страницу, чтобы лента была длиннее сразу
    } // Конец проверки наличия следующих страниц
  </script> <!-- Конец скрипта -->
</body> <!-- Конец тела -->
</html> <!-- Конец документа -->
