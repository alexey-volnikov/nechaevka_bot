<!doctype html> <!-- –û–±—ä—è–≤–ª—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
<html lang="ru"> <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<head> <!-- –ù–∞—á–∞–ª–æ —à–∞–ø–∫–∏ -->
  <meta charset="UTF-8" /> <!-- –ö–æ–¥–∏—Ä–æ–≤–∫–∞ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å -->
  <title>–ü—Ä–æ—Ñ–∏–ª—å {{ '—á–∞—Ç–∞' if entity_type == 'chat' else '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }}</title> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª–∞–¥–∫–∏ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" /> <!-- Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com" /> <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- –ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" /> <!-- –®—Ä–∏—Ñ—Ç Inter -->
  <style> /* –ù–∞—á–∞–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ç–∏–ª–µ–π */
    body { background: #0f172a; color: #e2e8f0; font-family: "Inter", system-ui, -apple-system, sans-serif; } /* –§–æ–Ω –∏ —Ç–µ–∫—Å—Ç */
    .glass { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; backdrop-filter: blur(10px); } /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Å—Ç–∏–ª—å */
    .shadow-soft { box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25); } /* –ú—è–≥–∫–∞—è —Ç–µ–Ω—å */
    .badge-soft { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; border: 1px solid rgba(99, 102, 241, 0.35); } /* –ú—è–≥–∫–∏–π –±–µ–π–¥–∂ */
    .avatar-lg { width: 64px; height: 64px; border-radius: 16px; object-fit: cover; } /* –ö—Ä—É–ø–Ω—ã–π –∞–≤–∞—Ç–∞—Ä */
    .avatar-inline { width: 1.6em; height: 1.6em; border-radius: 999px; object-fit: cover; flex-shrink: 0; } /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∞–≤–∞—Ç–∞—Ä */
    .stat-card { min-height: 140px; } /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .attachment-pill { display: inline-flex; gap: 6px; align-items: center; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(255, 255, 255, 0.05); color: #e2e8f0; font-size: 12px; text-decoration: none; } /* –ü–∏–ª—é–ª—è –≤–ª–æ–∂–µ–Ω–∏—è */
    .attachment-pill:hover { text-decoration: none; background: rgba(255, 255, 255, 0.08); } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–∏—è */
    .attachment-pending { border-style: dashed; background: rgba(59, 130, 246, 0.18); color: #cbd5e1; } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–ª–æ–∂–µ–Ω–∏—è */
    .attachment-failed { border-style: dashed; background: rgba(248, 113, 113, 0.2); color: #fecaca; border-color: rgba(248, 113, 113, 0.5); } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */
    .attachment-photo { border-color: rgba(59, 130, 246, 0.5); color: #bfdbfe; } /* –¶–≤–µ—Ç —Ñ–æ—Ç–æ */
    .attachment-video { border-color: rgba(244, 114, 182, 0.5); color: #fbcfe8; } /* –¶–≤–µ—Ç –≤–∏–¥–µ–æ */
    .attachment-doc { border-color: rgba(74, 222, 128, 0.5); color: #bbf7d0; } /* –¶–≤–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .attachment-link { border-color: rgba(14, 165, 233, 0.5); color: #bae6fd; } /* –¶–≤–µ—Ç —Å—Å—ã–ª–∫–∏ */
    .attachment-audio { border-color: rgba(56, 189, 248, 0.5); color: #bae6fd; } /* –¶–≤–µ—Ç –∞—É–¥–∏–æ */
    .attachment-sticker { border-color: rgba(248, 180, 0, 0.6); color: #fef08a; } /* –¶–≤–µ—Ç —Å—Ç–∏–∫–µ—Ä–∞ */
    .attachment-generic { border-color: rgba(148, 163, 184, 0.5); color: #e2e8f0; } /* –¶–≤–µ—Ç –ø—Ä–æ—á–µ–≥–æ */
    .table > :not(caption) > * > * { background-color: transparent; color: #e2e8f0; } /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —è—á–µ–π–∫–∏ */
    .table-striped > tbody > tr:nth-of-type(odd) > * { background: rgba(255, 255, 255, 0.03); } /* –ü–æ–ª–æ—Å–∞—Ç–æ—Å—Ç—å */
    .text-secondary-small { color: #94a3b8; font-size: 13px; } /* –°–µ—Ä—ã–π –º–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç */
    .gallery-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 16px; } /* –ó–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã–π —Ñ–æ–Ω –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-body { background: #0b1220; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; max-width: 900px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35); display: flex; flex-direction: column; gap: 12px; padding: 16px; } /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-media { position: relative; min-height: 320px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.03); border-radius: 12px; overflow: hidden; } /* –ë–ª–æ–∫ –º–µ–¥–∏–∞ */
    .gallery-media img, .gallery-media video { max-height: 540px; width: 100%; object-fit: contain; border-radius: 12px; background: #0b1220; } /* –ú–µ–¥–∏–∞ –≤–Ω—É—Ç—Ä–∏ –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-actions { display: flex; align-items: center; justify-content: space-between; gap: 12px; } /* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –≥–∞–ª–µ—Ä–µ–∏ */
    .gallery-meta { display: flex; flex-direction: column; gap: 4px; font-size: 14px; color: #cbd5e1; } /* –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–ª–æ–∂–µ–Ω–∏—è */
    .gallery-nav-btn { min-width: 42px; } /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .gallery-thumb { margin: 2px; } /* –û—Ç—Å—Ç—É–ø—ã –º–∏–Ω–∏–∞—Ç—é—Ä */
    .gallery-thumb.active { border-width: 2px !important; } /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –º–∏–Ω–∏–∞—Ç—é—Ä—ã */
  </style> <!-- –ö–æ–Ω–µ—Ü –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ç–∏–ª–µ–π -->
</head> <!-- –ö–æ–Ω–µ—Ü —à–∞–ø–∫–∏ -->
<body class="pb-5"> <!-- –¢–µ–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  {% include 'partials/gallery.html' %} <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â—É—é —Ä–∞–∑–º–µ—Ç–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–∞–ª–µ—Ä–µ–∏ -->
  <div class="container py-4"> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4 glass shadow-soft p-4"> <!-- –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
      <div class="d-flex align-items-center gap-3"> <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å —Å –∞–≤–∞—Ç–∞—Ä–æ–º -->
        {% if payload.summary.peer_avatar or payload.summary.from_avatar %} <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <img src="{{ payload.summary.peer_avatar or payload.summary.from_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-lg" /> <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä -->
        {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <div class="avatar-lg d-flex align-items-center justify-content-center bg-dark text-secondary">‚Äî</div> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
        {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
        <div> <!-- –ë–ª–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
          <div class="d-inline-flex align-items-center gap-2 mb-2"> <!-- –°—Ç—Ä–æ–∫–∞ –±–µ–π–¥–∂–µ–π -->
            <span class="badge-soft badge rounded-pill"> <!-- –ë–µ–π–¥–∂ —Ç–∏–ø–∞ —Å—É—â–Ω–æ—Å—Ç–∏ -->
              {{ '–ü—Ä–æ—Ñ–∏–ª—å —á–∞—Ç–∞' if entity_type == 'chat' else '–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }} <!-- –ü–æ–¥–ø–∏—Å—å –±–µ–π–¥–∂–∞ -->
            </span> <!-- –ö–æ–Ω–µ—Ü –±–µ–π–¥–∂–∞ -->
            {% if demo_mode %} <!-- –ï—Å–ª–∏ –¥–µ–º–æ-—Ä–µ–∂–∏–º -->
            <span class="badge bg-warning text-dark">–î–µ–º–æ</span> <!-- –ë–µ–π–¥–∂ –¥–µ–º–æ -->
            {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–º–æ -->
          </div> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –±–µ–π–¥–∂–µ–π -->
          <h1 class="fw-bold mb-1">{{ payload.summary.peer_title or payload.summary.from_name }}</h1> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º -->
          <p class="text-secondary mb-0">ID: {{ payload.summary.peer_id or payload.summary.from_id }} ‚Ä¢ –õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π: {{ limit }}</p> <!-- –ü–æ–¥–ø–∏—Å—å —Å ID –∏ –ª–∏–º–∏—Ç–æ–º -->
        </div> <!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ -->
      <div class="d-flex flex-wrap gap-2"> <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
        <a href="/" class="btn btn-outline-light">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–∞—à–±–æ—Ä–¥—É</a> <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <a href="/logs/full" class="btn btn-outline-light">–ö –ª–æ–≥–∞–º</a> <!-- –ö–Ω–æ–ø–∫–∞ –ª–æ–≥–æ–≤ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ -->
    </div> <!-- –ö–æ–Ω–µ—Ü —à–∞–ø–∫–∏ -->

    <div class="row g-3 mb-4"> <!-- –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.total_messages }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ -->
          <div class="text-secondary small">–í—Å–µ –∑–∞–ø–∏—Å–∏, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –±–∞–∑–µ</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">{{ '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π' if entity_type == 'chat' else '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤' }}</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1">{{ payload.summary.unique_senders if entity_type == 'chat' else payload.summary.unique_peers }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ -->
          <div class="text-secondary small">–°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è —Ç–∏–ø–∞ message</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
      <div class="col-12 col-md-4"> <!-- –¢—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="glass shadow-soft p-3 stat-card"> <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
          <div class="text-secondary-small">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
          <div class="h3 fw-bold mb-1" data-time>{{ payload.summary.last_message_time or '‚Äî' }}</div> <!-- –ó–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ -->
          <div class="text-secondary small">–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞</div> <!-- –ü–æ–¥–ø–∏—Å—å —É—Ç–æ—á–Ω–µ–Ω–∏—è -->
        </div> <!-- –ö–æ–Ω–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–ª–æ–Ω–∫–∏ -->
    </div> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->

    <div class="glass shadow-soft p-4"> <!-- –ë–ª–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π -->
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ -->
        <div> <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å -->
          <div class="card-title mb-1">–°–æ–æ–±—â–µ–Ω–∏—è</div> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <div class="text-secondary small">–°–≤–µ–∂–∏–µ –∑–∞–ø–∏—Å–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏</div> <!-- –ü–æ–¥–ø–∏—Å—å -->
        </div> <!-- –ö–æ–Ω–µ—Ü –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ -->
        <div class="d-flex align-items-center gap-2"> <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å -->
          <span class="badge-soft badge rounded-pill">READ ONLY</span> <!-- –ë–µ–π–¥–∂ —Ä–µ–∂–∏–º–∞ -->
          <span class="badge-soft badge rounded-pill">–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</span> <!-- –ë–µ–π–¥–∂ —Ç–∞–π–º–∑–æ–Ω—ã -->
        </div> <!-- –ö–æ–Ω–µ—Ü –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ -->
      </div> <!-- –ö–æ–Ω–µ—Ü –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
      <div class="table-responsive"> <!-- –û–±–µ—Ä—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
        {% set show_chat_column = entity_type != 'chat' %} <!-- –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ (—Å–∫—Ä—ã–≤–∞–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ —á–∞—Ç–∞) -->
        {% set show_sender_column = entity_type == 'chat' %} <!-- –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (—Å–∫—Ä—ã–≤–∞–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ —á–µ–ª–æ–≤–µ–∫–∞) -->
        {% set column_count = 3 + (1 if show_chat_column else 0) + (1 if show_sender_column else 0) %} <!-- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ colspan -->
        <table class="table table-striped align-middle mb-0"> <!-- –¢–∞–±–ª–∏—Ü–∞ -->
          <thead class="text-secondary"> <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
            <tr> <!-- –°—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ -->
              <th>–í—Ä–µ–º—è</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
              {% if show_chat_column %} <!-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü —á–∞—Ç–∞ -->
              <th>–ß–∞—Ç</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ —á–∞—Ç–∞ -->
              {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ -->
              {% if show_sender_column %} <!-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
              <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –∞–≤—Ç–æ—Ä–∞ -->
              {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
              <th>–í–ª–æ–∂–µ–Ω–∏—è</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π -->
              <th>–¢–µ–∫—Å—Ç</th> <!-- –ö–æ–ª–æ–Ω–∫–∞ —Ç–µ–∫—Å—Ç–∞ -->
            </tr> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ -->
          </thead> <!-- –ö–æ–Ω–µ—Ü –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
          <tbody> <!-- –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã -->
            {% if not payload.messages %} <!-- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö -->
            <tr> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ -->
              <td colspan="{{ column_count }}" class="text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td> <!-- –¢–µ–∫—Å—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤ -->
            </tr> <!-- –ö–æ–Ω–µ—Ü –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ -->
            {% else %} <!-- –í–µ—Ç–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
              {% for message in payload.messages %} <!-- –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è -->
              <tr> <!-- –°—Ç—Ä–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                {% set gallery_key = 'entity-msg-' ~ loop.index0 %} <!-- –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ -->
                <td data-time>{{ message.created_at or '‚Äî' }}</td> <!-- –Ø—á–µ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
                {% if show_chat_column %} <!-- –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü —á–∞—Ç–∞ -->
                <td> <!-- –Ø—á–µ–π–∫–∞ —á–∞—Ç–∞ -->
                  {% if message.peer_id %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å peer_id -->
                  <a href="/chat/{{ message.peer_id }}" target="_blank" class="text-decoration-none text-light d-inline-flex align-items-center gap-2"> <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç -->
                    {% if message.peer_avatar %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä -->
                    <img src="{{ message.peer_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-inline" /> <!-- –ê–≤–∞—Ç–∞—Ä —á–∞—Ç–∞ -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
                    <span>{{ message.peer_title or '–ß–∞—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</span> <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ -->
                  </a> <!-- –ö–æ–Ω–µ—Ü —Å—Å—ã–ª–∫–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ peer_id -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ peer_id -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ —á–∞—Ç–∞ -->
                {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ —á–∞—Ç–∞ -->
                {% if show_sender_column %} <!-- –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                <td> <!-- –Ø—á–µ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                  {% if message.from_id %} <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                  <a href="/user/{{ message.from_id }}" target="_blank" class="text-decoration-none text-light d-inline-flex align-items-center gap-2 flex-wrap"> <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    {% if message.from_avatar %} <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä -->
                    <img src="{{ message.from_avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-inline" /> <!-- –ê–≤–∞—Ç–∞—Ä -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
                    <span>{{ message.from_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å' }}</span> <!-- –ò–º—è -->
                    {% if message.is_bot %} <!-- –ï—Å–ª–∏ —ç—Ç–æ –±–æ—Ç -->
                    <span class="badge bg-info text-dark">–ë–æ—Ç</span> <!-- –ü–ª–∞—à–∫–∞ –±–æ—Ç–∞ -->
                    {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–æ—Ç–∞ -->
                  </a> <!-- –ö–æ–Ω–µ—Ü —Å—Å—ã–ª–∫–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ from_id -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                <td> <!-- –Ø—á–µ–π–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  {% set attachment_count = message.attachments|length if message.attachments else 0 %} <!-- –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  {% if attachment_count > 0 %} <!-- –ï—Å–ª–∏ –≤–ª–æ–∂–µ–Ω–∏—è –µ—Å—Ç—å -->
                  <span class="attachment-pill attachment-generic" data-gallery-key="{{ gallery_key }}">üìé {{ attachment_count }}</span> <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä–µ–ø–∫—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π —Å –∫–ª—é—á–æ–º –≥–∞–ª–µ—Ä–µ–∏ -->
                  {% else %} <!-- –í–µ—Ç–∫–∞ –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π -->
                  <span class="text-secondary">‚Äî</span> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä -->
                  {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π -->
                </td> <!-- –ö–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π -->
                <td>{{ message.text or '‚Äî' }}</td> <!-- –Ø—á–µ–π–∫–∞ —Ç–µ–∫—Å—Ç–∞ -->
              </tr> <!-- –ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
              {% endfor %} <!-- –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            {% endif %} <!-- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö -->
          </tbody> <!-- –ö–æ–Ω–µ—Ü —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã -->
        </table> <!-- –ö–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã -->
      </div> <!-- –ö–æ–Ω–µ—Ü –æ–±–µ—Ä—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->


    </div> <!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
  </div> <!-- –ö–æ–Ω–µ—Ü –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->

  <script src="{{ url_for('static', filename='js/gallery.js') }}"></script> <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –≥–∞–ª–µ—Ä–µ–∏ -->
  <script src="{{ url_for('static', filename='js/chat-history.js') }}"></script> <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ -->
  <script> // –ù–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    const timeCells = document.querySelectorAll('[data-time]'); // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –¥–∞—Ç–∞–º–∏
    const formatter = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'medium' }); // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    timeCells.forEach((cell) => { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const iso = cell.textContent.trim(); // –ë–µ—Ä–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É
      const parsed = iso ? new Date(iso) : null; // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
      cell.textContent = parsed && !Number.isNaN(parsed.valueOf()) ? formatter.format(parsed) : '‚Äî'; // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    }); // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞
    const galleryApi = window.galleryBridge || {}; // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â–∏–π API –≥–∞–ª–µ—Ä–µ–∏
    const chatApi = window.chatHistory || {}; // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    const serverMessages = {{ payload.messages | tojson }}; // –ó–∞–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
    chatApi.registerEntityGalleries(serverMessages, galleryApi); // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –æ–±—â–∏–π –º–æ–¥—É–ª—å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
  </script> <!-- –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞ -->
</body> <!-- –ö–æ–Ω–µ—Ü —Ç–µ–ª–∞ -->
</html> <!-- –ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
