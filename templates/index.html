<!doctype html> <!-- Объявляем тип документа -->
<html lang="ru"> <!-- Указываем язык страницы -->
<head> <!-- Начало заголовка страницы -->
  <meta charset="UTF-8" /> <!-- Кодировка UTF-8 для поддержки русского -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Масштабирование для мобильных -->
  <title>VK Bot Dashboard</title> <!-- Заголовок вкладки -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" /> <!-- Подключаем Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com" /> <!-- Оптимизируем загрузку шрифта -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- Разрешаем кросс-доменную загрузку шрифта -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" /> <!-- Подключаем шрифт Inter -->
  <style> /* Начало пользовательских стилей */
    body { background: #0f172a; color: #e2e8f0; font-family: "Inter", system-ui, -apple-system, sans-serif; } /* Фон и текст */
    .glass { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; backdrop-filter: blur(10px); } /* Стиль стекла */
    .hero { background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.1), transparent 35%), radial-gradient(circle at 80% 0%, rgba(94, 234, 212, 0.08), transparent 30%); } /* Подсветка героя */
    .badge-soft { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; border: 1px solid rgba(99, 102, 241, 0.35); } /* Мягкий бейдж */
    .metric { font-size: 32px; font-weight: 700; } /* Размер цифр метрик */
    .metric-sub { color: #94a3b8; font-size: 14px; } /* Подпись метрик */
    .card-title { font-weight: 700; letter-spacing: 0.02em; } /* Заголовок карточек */
    .table > :not(caption) > * > * { background-color: transparent; color: #e2e8f0; } /* Прозрачный фон таблицы */
    .table-striped > tbody > tr:nth-of-type(odd) > * { background: rgba(255, 255, 255, 0.03); } /* Полосатая таблица */
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.4); color: #cbd5e1; font-size: 13px; } /* Пилюли статуса */
    .stat-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; } /* Точка индикатора */
    .shadow-soft { box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25); } /* Мягкая тень */
    .chart-card { min-height: 320px; } /* Минимальная высота графика для компактности */
    .avatar-inline { width: 1.6em; height: 1.6em; border-radius: 999px; object-fit: cover; flex-shrink: 0; } /* Класс для маленьких аватарок по размеру текста */
  </style> <!-- Конец пользовательских стилей -->
</head> <!-- Конец заголовка -->
<body class="pb-5"> <!-- Тело страницы с нижним отступом -->
  <div class="container py-4"> <!-- Контейнер страницы -->
    <div class="p-4 p-md-5 mb-4 hero glass shadow-soft"> <!-- Блок героя -->
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3"> <!-- Верхняя строка героя -->
        <div> <!-- Левая часть -->
          <div class="d-inline-flex align-items-center gap-2 mb-2"> <!-- Бейджи статуса -->
            <span class="pill"> <!-- Пилюля статуса -->
              <span class="stat-dot bg-info"></span> <!-- Точка состояния -->
              Мониторинг активен <!-- Текст статуса -->
            </span> <!-- Конец пилюли -->
            <span class="pill" id="demo-badge" style="display: none;"> <!-- Пилюля демо -->
              <span class="stat-dot bg-warning"></span> <!-- Точка демо -->
              Демо-режим <!-- Подпись демо -->
            </span> <!-- Конец пилюли демо -->
          </div> <!-- Конец блока бейджей -->
          <h1 class="fw-bold mb-2">Дашборд VK-бота</h1> <!-- Заголовок героя -->
          <p class="text-secondary mb-0">Живые метрики лонгпулла, графики и последние сообщения без отправки от лица сообщества.</p> <!-- Подзаголовок -->
        </div> <!-- Конец левой части -->
        <div class="text-end"> <!-- Правая часть -->
          <div class="card glass shadow-soft px-4 py-3"> <!-- Карточка информации -->
            <div class="text-secondary small">Сообщество</div> <!-- Подпись -->
            <div class="fw-semibold text-light" id="group-name">—</div> <!-- Имя сообщества с более контрастным цветом -->
            <div class="text-secondary small" id="group-id">—</div> <!-- ID или адрес -->
            <div class="text-secondary small" id="group-members">—</div> <!-- Количество участников -->
          </div> <!-- Конец карточки -->
        </div> <!-- Конец правой части -->
      </div> <!-- Конец верхней строки героя -->
    </div> <!-- Конец героя -->

    <div class="glass shadow-soft p-4 mb-4"> <!-- Блок важных сообщений -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3"> <!-- Контейнер заголовка -->
        <div> <!-- Левая часть блока -->
          <div class="card-title mb-1" data-bs-toggle="tooltip" title="Здесь появляются критичные сигналы от сервиса">Важные сообщения</div> <!-- Заголовок блока с подсказкой -->
          <div class="text-secondary small">Ошибки и предупреждения сервисных процессов.</div> <!-- Подпись -->
        </div> <!-- Конец левой части -->
        <div class="d-flex align-items-center gap-2"> <!-- Правая часть -->
          <span id="important-badge" class="badge bg-danger fs-6">0</span> <!-- Бейдж количества -->
          <a href="/logs/full#service-alerts" class="btn btn-outline-light btn-sm">Перейти к оповещениям</a> <!-- Кнопка перехода -->
        </div> <!-- Конец правой части -->
      </div> <!-- Конец контейнера -->
    </div> <!-- Конец блока важных сообщений -->

    <div class="glass shadow-soft p-4 mb-4"> <!-- Блок выбора чата -->
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3"> <!-- Контейнер -->
        <div> <!-- Левая колонка -->
          <div class="card-title mb-1" data-bs-toggle="tooltip" title="Настройте, из каких чатов получать логи">Источник данных</div> <!-- Заголовок с подсказкой -->
          <div class="text-secondary small">Выберите конкретный peer_id или смотрите сразу все сообщения.</div> <!-- Подпись -->
        </div> <!-- Конец левой колонки -->
        <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center"> <!-- Контейнер селектора -->
          <label class="text-secondary small mb-0" for="peer-select">Фильтр по чату</label> <!-- Подпись селектора -->
          <select id="peer-select" class="form-select bg-dark text-light border-secondary" style="min-width: 240px"> <!-- Селектор чатов -->
            <option value="">Все чаты</option> <!-- Опция по умолчанию -->
          </select> <!-- Конец селектора -->
        </div> <!-- Конец контейнера селектора -->
      </div> <!-- Конец контейнера -->
    </div> <!-- Конец блока выбора чата -->

    <div class="glass shadow-soft p-4 mb-4"> <!-- Блок информации о файле базы -->
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3"> <!-- Контейнер -->
        <div> <!-- Левая колонка -->
          <div class="card-title mb-1" data-bs-toggle="tooltip" title="Локальный файл, куда пишутся все события бота">Файл логов событий</div> <!-- Заголовок с подсказкой -->
          <div class="text-secondary small">Файл автоматически создается рядом с проектом и пополняется при каждом событии.</div> <!-- Подпись -->
        </div> <!-- Конец левой колонки -->
        <div class="text-secondary small"> <!-- Правая колонка -->
          <div><span class="text-light">Путь:</span> <span id="storage-path">—</span></div> <!-- Строка пути -->
          <div><span class="text-light">Размер:</span> <span id="storage-size">—</span></div> <!-- Строка размера -->
          <div><span class="text-light">Статус:</span> <span id="storage-status">—</span></div> <!-- Строка статуса -->
        </div> <!-- Конец правой колонки -->
      </div> <!-- Конец контейнера -->
    </div> <!-- Конец блока информации о файле базы -->

    <div class="row g-4 mb-4"> <!-- Строка метрик -->
      <div class="col-12 col-md-3"> <!-- Колонка событий -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка -->
            <div class="d-flex justify-content-between align-items-center mb-2"> <!-- Заголовок карточки -->
              <div class="card-title" data-bs-toggle="tooltip" title="Сколько событий принято с момента запуска">События</div> <!-- Текст с подсказкой -->
              <span class="badge-soft badge rounded-pill">Live</span> <!-- Бейдж -->
            </div> <!-- Конец заголовка -->
            <div class="metric" id="events-count">0</div> <!-- Число событий -->
          <div class="metric-sub">Всего получено</div> <!-- Подпись -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-md-3"> <!-- Колонка сообщений -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка -->
            <div class="d-flex justify-content-between align-items-center mb-2"> <!-- Заголовок карточки -->
              <div class="card-title" data-bs-toggle="tooltip" title="Количество входящих сообщений">Сообщения</div> <!-- Текст с подсказкой -->
              <span class="badge bg-info text-dark">Входящие</span> <!-- Бейдж -->
            </div> <!-- Конец заголовка -->
            <div class="metric" id="messages-count">0</div> <!-- Число сообщений -->
          <div class="metric-sub">Новые за сессию</div> <!-- Подпись -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-md-3"> <!-- Колонка участников -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка -->
            <div class="d-flex justify-content-between align-items-center mb-2"> <!-- Заголовок карточки -->
              <div class="card-title" data-bs-toggle="tooltip" title="Сколько приглашений и выходов зафиксировано">Участники</div> <!-- Текст с подсказкой -->
              <span class="badge bg-success">Чаты</span> <!-- Бейдж -->
            </div> <!-- Конец заголовка -->
            <div class="metric" id="invites-count">0</div> <!-- Число событий -->
          <div class="metric-sub">Приглашения / удаления</div> <!-- Подпись -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-md-3"> <!-- Колонка ошибок -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка -->
            <div class="d-flex justify-content-between align-items-center mb-2"> <!-- Заголовок карточки -->
              <div class="card-title" data-bs-toggle="tooltip" title="Количество ошибок во время работы лонгпулла">Ошибки</div> <!-- Текст с подсказкой -->
              <span class="badge bg-danger">Лог</span> <!-- Бейдж -->
            </div> <!-- Конец заголовка -->
            <div class="metric" id="errors-count">0</div> <!-- Число ошибок -->
          <div class="metric-sub">Исключения лонгпулла</div> <!-- Подпись -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
    </div> <!-- Конец строки метрик -->

    <div class="row g-4"> <!-- Основная сетка -->
      <div class="col-12 col-lg-5"> <!-- Колонка с графиком (новая пропорция) -->
        <div class="glass p-4 shadow-soft chart-card"> <!-- Карточка графика -->
          <div class="d-flex justify-content-between align-items-center mb-3"> <!-- Заголовок графика -->
            <div>
              <div class="card-title mb-1" data-bs-toggle="tooltip" title="График скорости поступления событий">Динамика событий</div> <!-- Название с подсказкой -->
              <div class="text-secondary small">Обновляется каждые 3 секунды</div> <!-- Подпись -->
            </div>
            <div class="d-flex align-items-center gap-2"> <!-- Контейнер для селектора диапазона и статуса -->
              <select class="form-select form-select-sm bg-dark text-light" id="time-range-select"> <!-- Селектор временного диапазона -->
                <option value="15">15 минут</option> <!-- Опция 15 минут -->
                <option value="60">1 час</option> <!-- Опция 1 час -->
                <option value="360">6 часов</option> <!-- Опция 6 часов -->
                <option value="1440">24 часа</option> <!-- Опция 24 часа -->
              </select> <!-- Конец селектора -->
              <span class="pill"> <!-- Индикатор статуса лонгпулла -->
                <span class="stat-dot bg-info"></span> <!-- Точка -->
                Лонгпулл активен <!-- Подпись -->
              </span> <!-- Конец индикатора -->
            </div> <!-- Конец контейнера -->
          </div> <!-- Конец заголовка -->
          <canvas id="events-chart" height="260"></canvas> <!-- Полотно графика -->
        </div> <!-- Конец карточки графика -->
      </div> <!-- Конец колонки графика -->
      <div class="col-12 col-lg-7"> <!-- Колонка последних сообщений (новая пропорция) -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка сообщений -->
            <div class="d-flex justify-content-between align-items-center mb-3"> <!-- Заголовок -->
              <div>
                <div class="card-title mb-1" data-bs-toggle="tooltip" title="Свежие сообщения с сортировкой сверху вниз">Последние сообщения</div> <!-- Название с подсказкой -->
                <div class="text-secondary small">Новые сверху, отображаем последние записи</div> <!-- Подпись с подсказкой сортировки -->
              </div>
            <div class="d-flex align-items-center gap-2"> <!-- Контейнер кнопок -->
              <span class="badge-soft badge rounded-pill" id="timezone-badge" title="">Локальное время</span> <!-- Бейдж с подсказкой о часовом поясе -->
              <span class="badge-soft badge rounded-pill">READ ONLY</span> <!-- Бейдж readonly -->
              <a href="/logs/full" class="btn btn-outline-light btn-sm"> <!-- Кнопка просмотра всех сообщений -->
                Посмотреть все <!-- Текст кнопки -->
              </a> <!-- Конец кнопки -->
            </div> <!-- Конец контейнера кнопок -->
          </div> <!-- Конец заголовка -->
          <div class="table-responsive"> <!-- Обертка таблицы -->
            <table class="table table-sm table-striped align-middle mb-0"> <!-- Таблица сообщений -->
              <thead class="text-secondary"> <!-- Заголовок таблицы -->
                <tr>
                  <th>Чат</th> <!-- Заголовок столбца -->
                  <th>Отправитель</th> <!-- Заголовок столбца -->
                  <th>Бот?</th> <!-- Заголовок столбца для отметки бота -->
                  <th>Ответ</th> <!-- Заголовок столбца -->
                  <th>Вложения</th> <!-- Заголовок столбца -->
                  <th>Текст</th> <!-- Заголовок столбца -->
                </tr>
              </thead>
              <tbody id="messages-body"> <!-- Тело таблицы -->
                <tr>
                  <td colspan="6" class="text-secondary">Нет данных</td> <!-- Плейсхолдер -->
                </tr>
              </tbody>
            </table> <!-- Конец таблицы -->
          </div> <!-- Конец обертки таблицы -->
        </div> <!-- Конец карточки сообщений -->
      </div> <!-- Конец колонки сообщений -->
    </div> <!-- Конец основной сетки -->

    <div class="row g-4 mt-4"> <!-- Вторая строка -->
      <div class="col-12 col-xl-6"> <!-- Колонка диалогов -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка диалогов -->
          <div class="d-flex justify-content-between align-items-center mb-3"> <!-- Заголовок -->
            <div class="card-title mb-1" data-bs-toggle="tooltip" title="Список диалогов, доступных боту">Диалоги и чаты</div> <!-- Название с подсказкой -->
            <span class="badge bg-secondary">Read-only</span> <!-- Бейдж -->
          </div> <!-- Конец заголовка -->
          <div class="table-responsive"> <!-- Обертка таблицы -->
            <table class="table table-striped align-middle mb-0"> <!-- Таблица диалогов -->
              <thead class="text-secondary"> <!-- Заголовок -->
                <tr>
                  <th>peer_id</th> <!-- Заголовок идентификатора чата -->
                  <th>Тип</th> <!-- Заголовок типа диалога -->
                  <th>Название</th> <!-- Заголовок названия чата -->
                  <th>Сообщений</th> <!-- Заголовок количества сообщений -->
                </tr>
              </thead>
              <tbody id="conversations-body"> <!-- Тело -->
                <tr>
                  <td colspan="4" class="text-secondary">Нет данных</td> <!-- Плейсхолдер -->
                </tr>
              </tbody>
            </table> <!-- Конец таблицы -->
          </div> <!-- Конец обертки -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
      <div class="col-12 col-xl-6"> <!-- Колонка заметок -->
        <div class="glass p-4 shadow-soft h-100"> <!-- Карточка заметок -->
          <div class="card-title mb-3" data-bs-toggle="tooltip" title="Краткие советы по безопасной работе с ботом">Памятка безопасности</div> <!-- Заголовок с подсказкой -->
          <ul class="text-secondary small mb-0"> <!-- Список -->
            <li>Токен хранится только в `.env`, не коммитится и не выводится на страницу.</li> <!-- Пункт -->
            <li>Бот читает события, но не отправляет сообщения в чатах.</li> <!-- Пункт -->
            <li>Если включен демо-режим (`DEMO_MODE=1`), данные берутся из примеров.</li> <!-- Пункт -->
            <li>Для live режима убедитесь, что порт из `.env` открыт в Windows или WSL.</li> <!-- Пункт -->
          </ul> <!-- Конец списка -->
        </div> <!-- Конец карточки -->
      </div> <!-- Конец колонки -->
    </div> <!-- Конец второй строки -->
  </div> <!-- Конец контейнера -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> <!-- Подключаем Bootstrap JS для тултипов -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> <!-- Подключаем Chart.js -->
  <script> // Начало скрипта
    const initialStats = {{ initial_stats|tojson }}; // Читаем стартовые метрики из шаблона без ручного парсинга, чтобы не было ошибок на кавычках
    const initialGroup = {{ initial_group|tojson }}; // Читаем информацию о сообществе в безопасном виде
    const initialConversations = {{ initial_conversations|tojson }}; // Читаем список диалогов без риска испортить JSON
    const initialPeers = {{ initial_peers|tojson }}; // Читаем стартовый список peer_id без ошибок экранирования
    const initialStorage = {{ initial_storage|tojson }}; // Читаем стартовую информацию о файле базы
    const demoMode = {{ 'true' if demo_mode else 'false' }}; // Флаг демо-режима

    const eventsEl = document.getElementById('events-count'); // Находим элемент событий
    const messagesEl = document.getElementById('messages-count'); // Находим элемент сообщений
    const invitesEl = document.getElementById('invites-count'); // Находим элемент приглашений
    const errorsEl = document.getElementById('errors-count'); // Находим элемент ошибок
    const messagesBody = document.getElementById('messages-body'); // Тело таблицы сообщений
    const conversationsBody = document.getElementById('conversations-body'); // Тело таблицы диалогов
    const groupNameEl = document.getElementById('group-name'); // Заголовок сообщества
    const groupIdEl = document.getElementById('group-id'); // ID сообщества
    const groupMembersEl = document.getElementById('group-members'); // Количество участников
    const demoBadge = document.getElementById('demo-badge'); // Бейдж демо
    const peerSelect = document.getElementById('peer-select'); // Селектор чатов
    const storagePathEl = document.getElementById('storage-path'); // Путь до файла базы
    const storageSizeEl = document.getElementById('storage-size'); // Размер файла базы
    const storageStatusEl = document.getElementById('storage-status'); // Статус существования файла
    const importantBadge = document.getElementById('important-badge'); // Бейдж важных оповещений
    const timeRangeSelect = document.getElementById('time-range-select'); // Селектор выбора диапазона времени
    let currentPeer = ''; // Текущий выбранный peer_id
    let selectedRange = Number(initialStats?.range_minutes ?? 60); // Текущий выбранный диапазон минут

    const timezoneInfo = Intl.DateTimeFormat().resolvedOptions(); // Считываем параметры локальной таймзоны браузера
    const timezoneOffsetMinutes = new Date().getTimezoneOffset(); // Получаем смещение от UTC в минутах
    const timezoneOffsetSign = timezoneOffsetMinutes <= 0 ? '+' : '-'; // Определяем знак смещения
    const timezoneOffsetHours = String(Math.floor(Math.abs(timezoneOffsetMinutes) / 60)).padStart(2, '0'); // Вычисляем часы смещения с ведущим нулем
    const timezoneOffsetRestMinutes = String(Math.abs(timezoneOffsetMinutes) % 60).padStart(2, '0'); // Вычисляем минуты смещения с ведущим нулем
    const timezoneLabel = `UTC${timezoneOffsetSign}${timezoneOffsetHours}:${timezoneOffsetRestMinutes} (${timezoneInfo.timeZone || 'локальное время'})`; // Формируем подпись таймзоны и смещения
    const timeFormatter = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: timezoneInfo.timeZone, timeZoneName: 'short' }); // Настраиваем формат вывода времени

    document.getElementById('timezone-badge').title = `Отображается время ${timezoneLabel}`; // Обновляем подсказку бейджа таймзоны

    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]')); // Собираем все элементы, на которых нужно активировать тултипы
    tooltipTriggerList.forEach((triggerEl) => new bootstrap.Tooltip(triggerEl)); // Инициализируем Bootstrap тултипы для каждого элемента

    if (timeRangeSelect) { // Если селектор диапазона найден
      timeRangeSelect.value = String(selectedRange); // Устанавливаем текущее значение из стартовых данных
      timeRangeSelect.addEventListener('change', () => { // Подписываемся на изменение диапазона
        selectedRange = Number(timeRangeSelect.value || 60); // Обновляем выбранный диапазон
        poll(); // Запускаем немедленное обновление данных
      }); // Конец обработчика изменения
    } // Конец проверки селектора

    function formatDateTime(value) { // Функция форматирования даты
      const parsed = value ? new Date(value) : null; // Создаем объект даты при наличии значения
      return parsed && !Number.isNaN(parsed.valueOf()) ? timeFormatter.format(parsed) : '—'; // Возвращаем отформатированную строку или тире
    } // Конец функции форматирования

    if (demoMode) { // Если включен демо-режим
      demoBadge.style.display = 'inline-flex'; // Показываем бейдж демо
    } // Конец условия демо

    const ctx = document.getElementById('events-chart'); // Получаем холст графика
    const chart = new Chart(ctx, { // Создаем график
      type: 'line', // Тип графика
      data: { // Данные графика
        labels: initialStats.timeline.map((p) => formatDateTime(p.time)), // Метки времени в локальном формате
        datasets: [ // Наборы данных
          { label: 'События', data: initialStats.timeline.map((p) => p.events), borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.25)', tension: 0.3, fill: true }, // Линия событий
          { label: 'Сообщения', data: initialStats.timeline.map((p) => p.messages), borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.25)', tension: 0.3, fill: true }, // Линия сообщений
          { label: 'Участники', data: initialStats.timeline.map((p) => p.invites), borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.25)', tension: 0.3, fill: true }, // Линия участников
        ], // Конец наборов
      }, // Конец данных
      options: { // Настройки графика
        plugins: { legend: { labels: { color: '#cbd5e1' } } }, // Цвет легенды
        scales: { // Настройки осей
          x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.04)' } }, // Ось X
          y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.04)' } }, // Ось Y
        }, // Конец осей
      }, // Конец настроек
    }); // Конец создания графика

    function renderGroup(data) { // Функция вывода информации о сообществе
      groupNameEl.textContent = data.name || '—'; // Отображаем название
      groupIdEl.textContent = data.screen_name ? `vk.com/${data.screen_name}` : 'ID: ' + (data.id || '—'); // Отображаем адрес
      groupMembersEl.textContent = data.members_count ? `${data.members_count} участников` : 'Участники: —'; // Отображаем участников
    } // Конец функции

    function buildAvatarLabel(label, avatarUrl) { // Функция построения подписи с аватаркой
      const safeLabel = label || '—'; // Определяем подпись, если значения нет
      if (avatarUrl) { // Если есть ссылка на аватар
        return `<span class="d-inline-flex align-items-center gap-2"><img src="${avatarUrl}" alt="Аватар" class="avatar-inline" loading="lazy" /> <span>${safeLabel}</span></span>`; // Возвращаем подпись с картинкой
      } // Конец проверки аватара
      return safeLabel; // Если аватар отсутствует, возвращаем только текст
    } // Конец функции построения подписи

    function buildReplyPreview(reply, peerId) { // Функция сборки ячейки ответа
      if (!reply || (!reply.id && !reply.text && !reply.from_id)) { // Проверяем наличие полезных данных
        return '<span class="text-secondary">—</span>'; // Возвращаем плейсхолдер при отсутствии ответа
      } // Конец проверки наличия ответа
      const replyId = reply.id ?? '—'; // Определяем ID исходного сообщения
      const replyText = reply.text ? reply.text.slice(0, 120) : 'Без текста'; // Готовим превью текста
      const replyAuthorLabel = reply.from_name ? `${reply.from_name} (ID: ${reply.from_id ?? '—'})` : reply.from_id ? `ID: ${reply.from_id}` : 'Автор неизвестен'; // Формируем подпись автора ответа
      const replyAuthorCell = buildAvatarLabel(replyAuthorLabel, reply.from_avatar); // Готовим подпись автора с аватаркой
      const replyLink = reply.id && peerId ? `<a href="https://vk.com/im?sel=${peerId}&msgid=${reply.id}" target="_blank" rel="noopener noreferrer">#${reply.id}</a>` : `#${replyId}`; // Собираем ссылку на исходное сообщение
      const replyAttachmentsCount = Array.isArray(reply.attachments) ? reply.attachments.length : 0; // Считаем вложения исходного сообщения
      const replyAttachmentsLabel = replyAttachmentsCount ? `${replyAttachmentsCount} влож.` : 'Без вложений'; // Формируем подпись вложений
      return `<div class="d-flex flex-column gap-1"><div class="d-flex align-items-center gap-2">${replyLink}<span class="text-secondary small">${replyAttachmentsLabel}</span></div><div class="text-secondary small">${replyText}</div><div class="text-secondary small">${replyAuthorCell}</div></div>`; // Возвращаем HTML ячейки
    } // Конец функции сборки ответа

    function renderMessages(messages) { // Функция отрисовки сообщений
      messagesBody.innerHTML = ''; // Очищаем тело таблицы
      if (!messages.length) { // Если пусто
        messagesBody.innerHTML = '<tr><td colspan="6" class="text-secondary">Нет данных</td></tr>'; // Плейсхолдер
        return; // Выходим
      } // Конец проверки пустоты
      messages.forEach((msg) => { // Перебираем сообщения по порядку от новых к старым
        const row = document.createElement('tr'); // Создаем строку
        const attachments = Array.isArray(msg.attachments) ? msg.attachments.length : 0; // Считаем вложения
        const botBadge = msg.is_bot ? 'Да' : 'Нет'; // Определяем, является ли автор ботом
        const peerLabel = msg.peer_title ? `${msg.peer_title} (ID: ${msg.peer_id ?? '—'})` : `${msg.peer_id ?? '—'}`; // Формируем подпись чата
        const authorLabel = msg.from_name ? `${msg.from_name} (ID: ${msg.from_id ?? '—'})` : `${msg.from_id ?? '—'}`; // Формируем подпись автора
        const peerCell = buildAvatarLabel(peerLabel, msg.peer_avatar); // Готовим ячейку чата с аватаркой
        const authorCell = buildAvatarLabel(authorLabel, msg.from_avatar); // Готовим ячейку автора с аватаркой
        const replyCell = buildReplyPreview(msg.reply, msg.peer_id); // Готовим ячейку превью исходного сообщения
        row.innerHTML = `<td>${peerCell}</td><td>${authorCell}</td><td>${botBadge}</td><td>${replyCell}</td><td>${attachments}</td><td>${msg.text ?? ''}</td>`; // Заполняем ячейки
        messagesBody.appendChild(row); // Добавляем строку в таблицу
      }); // Конец цикла
    } // Конец функции

    function renderPeers(peers) { // Функция отрисовки списка чатов
      const uniquePeers = Array.from( // Формируем массив уникальных чатов
        new Map( // Создаем словарь уникальности по ID
          (peers || []) // Берем входные чаты
            .filter((p) => p && Number.isFinite(p.id)) // Убираем пустые записи
            .map((p) => [p.id, p]) // Превращаем в пары ключ-значение
        ).values() // Берем только значения словаря
      ); // Завершаем сборку массива
      peerSelect.innerHTML = '<option value="">Все чаты</option>'; // Сбрасываем список
      uniquePeers.forEach((peer) => { // Перебираем чаты
        const option = document.createElement('option'); // Создаем опцию
        option.value = peer.id; // Значение
        const label = peer.title ? `${peer.title} (ID: ${peer.id})` : peer.id; // Формируем подпись
        option.textContent = label; // Текст
        peerSelect.appendChild(option); // Добавляем в селектор
      }); // Конец цикла
      if (currentPeer && uniquePeers.some((p) => p.id === Number(currentPeer))) { // Если выбранный чат все еще существует
        peerSelect.value = currentPeer; // Возвращаем выбор
      } else { // Если выбора нет
        currentPeer = ''; // Сбрасываем фильтр
        peerSelect.value = ''; // Возвращаем опцию по умолчанию
      } // Конец условия
    } // Конец функции

    function renderConversations(convs) { // Функция отрисовки диалогов
      conversationsBody.innerHTML = ''; // Очищаем таблицу
      if (!convs.length) { // Если нет данных
        conversationsBody.innerHTML = '<tr><td colspan="4" class="text-secondary">Нет данных</td></tr>'; // Плейсхолдер
        return; // Выходим
      } // Конец проверки
      const translatedTypes = { chat: 'беседа', user: 'диалог', group: 'сообщество', unknown: 'неизвестно' }; // Словарь переводов типов
      const sortedConvs = [...convs].sort((a, b) => { // Копируем и сортируем диалоги
        const aHasTitle = Boolean(a?.chat_settings?.title); // Есть ли название у первого диалога
        const bHasTitle = Boolean(b?.chat_settings?.title); // Есть ли название у второго диалога
        if (aHasTitle !== bHasTitle) { // Если различается наличие названия
          return aHasTitle ? -1 : 1; // Сначала диалоги с названием
        } // Конец проверки наличия названия
        const aCount = Number(a?.messages_count ?? 0); // Количество сообщений для первого диалога
        const bCount = Number(b?.messages_count ?? 0); // Количество сообщений для второго диалога
        return bCount - aCount; // Сортируем по убыванию количества сообщений
      }); // Конец сортировки
      sortedConvs.forEach((conv) => { // Перебираем отсортированные диалоги
        const peer = conv.peer || {}; // Получаем peer
        const title = conv.chat_settings?.title || '—'; // Получаем название чата
        const type = peer.type || 'unknown'; // Получаем тип
        const localizedType = translatedTypes[type] || translatedTypes.unknown; // Переводим тип на русский
        const messagesCount = Number(conv.messages_count ?? 0); // Нормализуем количество сообщений
        const avatarUrl = conv.chat_settings?.photo?.photo_50 || conv.chat_settings?.photo?.photo_100 || conv.peer?.avatar; // Определяем ссылку на аватар беседы
        const titleCell = buildAvatarLabel(title, avatarUrl); // Формируем подпись с аватаркой
        const row = document.createElement('tr'); // Создаем строку
        row.innerHTML = `<td>${peer.id ?? '—'}</td><td>${localizedType}</td><td>${titleCell}</td><td>${messagesCount}</td>`; // Заполняем строку
        conversationsBody.appendChild(row); // Добавляем строку
      }); // Конец цикла
    } // Конец функции

    function updateMetrics(stats) { // Функция обновления чисел
      eventsEl.textContent = stats.events; // Обновляем количество событий
      messagesEl.textContent = stats.messages; // Обновляем количество сообщений
      invitesEl.textContent = stats.invites; // Обновляем количество приглашений
      errorsEl.textContent = stats.errors; // Обновляем количество ошибок
      chart.data.labels = stats.timeline.map((p) => formatDateTime(p.time)); // Обновляем метки графика в локальном формате
      chart.data.datasets[0].data = stats.timeline.map((p) => p.events); // Обновляем линию событий
      chart.data.datasets[1].data = stats.timeline.map((p) => p.messages); // Обновляем линию сообщений
      chart.data.datasets[2].data = stats.timeline.map((p) => p.invites); // Обновляем линию участников
      chart.update(); // Перерисовываем график
      if (stats.range_minutes && timeRangeSelect) { // Если в ответе есть диапазон и селектор существует
        selectedRange = Number(stats.range_minutes); // Обновляем выбранный диапазон
        timeRangeSelect.value = String(stats.range_minutes); // Синхронизируем значение селектора
      } // Конец проверки диапазона
    } // Конец функции

    function renderStorage(storage) { // Функция вывода информации о файле базы
      storagePathEl.textContent = storage.path || '—'; // Показываем путь до файла
      const sizeKb = storage.size_bytes ? Math.max(1, Math.round(storage.size_bytes / 1024)) : 0; // Переводим байты в килобайты
      storageSizeEl.textContent = storage.size_bytes ? `${sizeKb} КБ` : '0 КБ'; // Показываем размер
      storageStatusEl.textContent = storage.exists ? 'Создан и доступен' : 'Файла пока нет'; // Показываем статус
      storageStatusEl.className = storage.exists ? 'text-success' : 'text-warning'; // Меняем цвет статуса
    } // Конец функции

    function updateImportantBadge(count) { // Функция обновления бейджа важных сообщений
      const safeCount = Number(count) || 0; // Нормализуем значение
      importantBadge.textContent = safeCount; // Выводим число
      importantBadge.className = safeCount > 0 ? 'badge bg-danger fs-6' : 'badge bg-secondary fs-6'; // Меняем цвет по наличию событий
    } // Конец функции бейджа

    function bootstrapPage() { // Инициализация страницы
      renderGroup(initialGroup || {}); // Показываем данные сообщества
      renderConversations(initialConversations || []); // Показываем диалоги
      renderPeers(initialPeers || []); // Показываем стартовые peer_id
      updateMetrics(initialStats || { timeline: [] }); // Показываем метрики
      renderStorage(initialStorage || {}); // Показываем информацию о файле базы
      updateImportantBadge(0); // Сбрасываем бейдж важных сообщений
    } // Конец функции

    async function poll() { // Функция периодического опроса
      try { // Пытаемся отправить запрос
        const logsUrl = currentPeer ? `/api/logs?peer_id=${currentPeer}` : '/api/logs'; // Формируем URL логов
        const alertsUrl = '/api/service-logs?event_type=important&limit=1'; // URL для важных оповещений
        const statsUrl = `/api/stats?range=${selectedRange}`; // Формируем URL статистики с выбранным диапазоном
        const [statsRes, overviewRes, logsRes, alertsRes] = await Promise.all([fetch(statsUrl), fetch('/api/overview'), fetch(logsUrl), fetch(alertsUrl)]); // Запрашиваем статистику, обзор, логи и оповещения
        const stats = await statsRes.json(); // Читаем JSON статистики
        const overview = await overviewRes.json(); // Читаем JSON обзора
        const logs = await logsRes.json(); // Читаем JSON логов
        const alerts = await alertsRes.json(); // Читаем JSON оповещений
        updateMetrics(stats); // Обновляем метрики
        renderGroup(overview.group || {}); // Обновляем информацию о сообществе
        renderConversations(overview.conversations || []); // Обновляем диалоги
        renderPeers(overview.peers || []); // Обновляем список чатов
        renderMessages(logs.items || []); // Обновляем таблицу сообщений
        renderStorage(overview.storage || initialStorage || {}); // Обновляем данные о файле базы
        updateImportantBadge(alerts.total || 0); // Обновляем бейдж важных сообщений
      } catch (err) { // В случае ошибки
        console.error('Ошибка обновления дашборда', err); // Пишем ошибку в консоль
      } // Конец обработки ошибки
    } // Конец функции

    peerSelect.addEventListener('change', () => { // Реагируем на выбор чата
      currentPeer = peerSelect.value; // Сохраняем выбранный peer_id
      poll(); // Перезапрашиваем данные
    }); // Конец обработчика

    bootstrapPage(); // Запускаем инициализацию
    poll(); // Делаем первый запрос сразу после загрузки страницы
    setInterval(poll, 3000); // Опрос каждые 3 секунды
  </script> <!-- Конец скрипта -->
</body> <!-- Конец тела -->
</html> <!-- Конец документа -->
