# nechaevka_bot

Полноценный мониторинговый бот для сообщества ВКонтакте. Скрипт подключается к Long Poll API, читает входящие события, строит графики в локальном дашборде и **никогда не отправляет сообщения** от лица сообщества. Все переменные лежат в `.env`, есть демо-режим без VK API, а инструкции написаны под VS Code на Windows (можно через Docker Desktop или WSL). Теперь дашборд умеет хранить все события в локальной базе SQLite (`logs.db`), показывает полный список чатов (`peer_id`) и позволяет фильтровать сообщения по выбранному чату.

> Главное правило: бот только читает. Токен хранится локально и не попадает в репозиторий.

> Главное правило: бот ничего не отправляет в чаты и используется только для чтения. Токен хранится локально в `.env`, этот файл не попадает в репозиторий. Все шаги расписаны для начинающих, чтобы можно было повторить в VS Code на Windows (в том числе через Docker Desktop или WSL, если хотите изолировать окружение).

## Что умеет
- Читает события из Long Poll и ведет живую статистику (сообщения, приглашения, ошибки).
- Показывает последние сообщения (peer_id, from_id, ответ, вложения, текст) в таблице дашборда.
- Визуализирует динамику событий на графике (Chart.js) и обновляет каждые 3 секунды.
- Показывает информацию о сообществе и списке доступных диалогов (только чтение).
- Имеет демо-режим `DEMO_MODE=1`, чтобы посмотреть UI без реального токена.
- Сохраняет все входящие сообщения вместе с вложениями в базу `logs.db`, чтобы можно было анализировать историю.
- Подтягивает названия чатов и имена отправителей через VK API, сохраняя их вместе с оригинальными ID.
- Позволяет выбрать конкретный `peer_id` и смотреть логи только по нужному чату, показывая человекочитаемые названия.
- Помечает, когда пишет другой бот или сообщество (колонка «Бот?» в таблице логов), чтобы проще искать автоматические ответы.
- Показывает отдельную страницу `/logs/full` со всеми последними сообщениями (до 1000 строк) и фильтром по чату.
- Поднимается локально или в Docker/Compose, пробрасывая порт дашборда.
- Записывает сервисные события (старт, выдача эндпоинтов, ошибки загрузки данных) в отдельный файл `data/service.log` с ротацией и русскими пояснениями кодов статусов.
- Сохраняет сервисные оповещения (info/warning/error) в базу `logs.db` с локальным временем, поддерживает очистку через POST `/api/service-logs/clear` и выводит их в UI.

### Что дает база логов
- В файле `logs.db` лежат все события типа `message` с полным payload VK (текст, вложения, ответы).
- Таблица `events` хранит имя чата (`peer_title`), имя отправителя (`from_name`), оригинальные ID, флаг бота и полный payload; её можно открыть через любой SQLite-клиент или встроенную панель VS Code.
- Фильтр в UI использует эти данные, но вы можете подключить `logs.db` к n8n/метрикам или экспортировать в CSV.
- По умолчанию файл лежит в `./data/logs.db` (папка создается автоматически, пробрасывается на хост в Docker и отображается в блоке «Файл логов событий» на дашборде). Если хотите положить в другое место, задайте `EVENT_DB` или пару `EVENT_DB_DIR`+`EVENT_DB_NAME`.
- Страница `/logs/full` грузит логи напрямую из `logs.db` и поддерживает фильтры `peer_id` + `limit` (до 1000 строк), так что можно быстро увидеть весь поток событий и убедиться, что записи появляются.
- Там же добавлен блок «Сервисные оповещения» с кнопкой очистки и фильтром по уровню (info/warning/error/important); данные подтягиваются через `/api/service-logs` с параметрами `event_type`, `limit`, `offset`.

## Подготовка окружения (с нуля)
1. **Установите Python 3.10+**. На Windows удобнее скачать с https://www.python.org/downloads/ и поставить галочку «Add Python to PATH».
2. **Скачайте проект** (кнопка Code → Download ZIP или `git clone` если установлен git).
3. **Создайте виртуальное окружение**, чтобы зависимости не смешивались с системой:
   ```bash
   python -m venv .venv
   .venv\Scripts\activate  # Windows (PowerShell)
   # source .venv/bin/activate  # Если вы в WSL или Linux
   ```
4. **Установите все модули одной командой** (нужен интернет):
   ```bash
   pip install -r requirements.txt
   ```
   Если появилось сообщение, что модуль не найден — просто повторите команду; она подтягивает все зависимости сразу.
5. **Создайте собственный `.env`, не коммитя его в git**:
   - Скопируйте пример: `copy .env.example .env` (Windows PowerShell) или `cp .env.example .env` (WSL/Linux).
   - Заполните файл без кавычек:
     ```
     VK_GROUP_TOKEN=vk1.a.пример_длинного_токена
     VK_GROUP_ID=123456
     PORT=8000
     DEMO_MODE=0
     ```
   - `VK_GROUP_TOKEN` — токен с правами «Сообщения сообщества» (Настройки → Работа с API → Создать ключ).
   - `VK_GROUP_ID` — числовой ID без `club`/`public`. Если адрес `vk.com/club123456`, пишем `123456`.
   - `.env` уже в `.gitignore`, поэтому не попадет в коммиты. Перед `git add` можно проверить `git status`.

## Запуск
1. Активируйте виртуальное окружение и выполните:
   ```bash
   python app.py
   ```
2. Держите окно терминала открытым: там будут логи VK API.
3. Откройте `http://127.0.0.1:8000`:
   - Главная страница — дашборд: карточки метрик, график событий, таблицы последних сообщений и диалогов.
   - `/api/stats` — JSON статистики (можно подключить к n8n или другой автоматизации).
   - `/api/overview` — JSON с данными сообщества и диалогов.
4. Если окно терминала закрывается при двойном клике по `app.py`, откройте VS Code → Terminal → `python app.py`. При ошибке окно не закроется сразу, можно прочитать текст.
5. Для просмотра сырых логов можно зайти на `http://127.0.0.1:8000/api/logs` или добавить `?peer_id=XXX`, чтобы получить JSON по конкретному чату.

### Демо-режим (без токена)
- В `.env` поставьте `DEMO_MODE=1`, остальные поля можно не заполнять.
- Запустите `python app.py` — увидите UI с примерными данными и графиком.
- Чтобы вернуться к реальному VK, смените `DEMO_MODE` на `0` и заполните `VK_GROUP_TOKEN`/`VK_GROUP_ID`.

### Частые причины «сервер не открывается»
- Не заполнены `VK_GROUP_TOKEN` или `VK_GROUP_ID` — приложение упадет с подсказкой в консоли.
- Порт `8000` занят: поменяйте `PORT` в `.env` или левую часть в `docker-compose.yml` (например, `8001:8000`).
- Файрвол блокирует вход: добавьте исключение для `python.exe` или Docker Desktop.
- Нет интернета или VK API недоступен: в логах будет предупреждение, дашборд поднимется с пустыми данными.

### Если ругается на «модуль не установлен»
- Проверьте, что активировано виртуальное окружение (`.venv`).
- В активном окружении повторно выполните `pip install -r requirements.txt`.
- Можно запустить автоматизацию на Windows:
  ```powershell
  powershell -ExecutionPolicy Bypass -File .\install_all.ps1
  ```

## Запуск через Docker (Desktop или WSL)
1. Установите Docker Desktop и убедитесь, что демон запущен.
2. Создайте `.env` в корне (как в инструкции выше). Файл не попадет в образ, но будет передан в контейнер.
3. Запуск через Docker Compose (сборка + старт):
   ```bash
   docker compose up --build
   ```
   - Если порт 8000 занят, поменяйте левое число в `docker-compose.yml`, например `"8001:8000"`.
   - База логов лежит на хосте в `./data/logs.db` (папка появится рядом с проектом). Файл можно открыть из VS Code на Windows или подключить к n8n.
4. Ручной запуск:
   ```bash
   docker build -t nechaevka_bot_image .
   docker run --env-file .env -p 8000:8000 --name nechaevka_bot nechaevka_bot_image
   ```
5. Откройте `http://127.0.0.1:8000` и смотрите дашборд.

### Зачем Docker в этом проекте
- Изоляция: код и зависимости в одном образе, система не засоряется.
- Повторяемость: на любой машине с Docker получите одинаковый результат.
- Простая очистка: удалили контейнер/образ — удалили следы.

## Потенциал
- Хранить события в базе и строить исторические графики.
- Добавить фильтры по чатам/ID и экспорт в CSV.
- Подключить алерты (webhook или n8n) по ошибкам лонгпулла.
